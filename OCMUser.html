<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>OCM User</title>
<script src="app-config.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head><body>
<h1>Create OCM Listing</h1>
<div id="loginStatus"></div>
<form onsubmit="createListing(event)">
  <select id="type">
    <option value="BUY">BUY</option>
    <option value="SELL">SELL</option>
  </select>
  <input id="itemName" placeholder="Item name">
  <select id="unit"><option value="EACH">EACH</option><option value="STACK">STACK</option></select>
  <input id="bundleSize" type="number" placeholder="Stack size (if STACK)" min="1">
  <input id="priceBT" type="number" step="0.01" placeholder="Price BT">
  <input id="qtyAvailable" type="number" placeholder="Qty (optional)" min="1">
  <button type="submit">Create</button>
</form>
<div id="msg"></div>
<script>
let googleIdToken=null;
function onGoogleSignIn(r){ googleIdToken=r.credential; document.getElementById('loginStatus').textContent='Logged in.'; }
function recaptchaWrap(){ return new Promise((res,rej)=>{ grecaptcha.ready(()=>grecaptcha.execute(RECAPTCHA_SITE_KEY,{action:'submit'}).then(res).catch(rej)); }); }
function createListing(e){
  e.preventDefault();
  if(!googleIdToken){ alert('Login first'); return; }
  const payload={
    type:document.getElementById('type').value,
    itemName:document.getElementById('itemName').value.trim(),
    unit:document.getElementById('unit').value,
    bundleSize:parseInt(document.getElementById('bundleSize').value)||null,
    priceBT:parseFloat(document.getElementById('priceBT').value)||0,
    qtyAvailable:document.getElementById('qtyAvailable').value||''
  };
  recaptchaWrap().then(token=>{
    return fetch(WEB_APP_URL,{ method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ action:'createListing', idToken:googleIdToken, recaptchaToken:token, payload }) });
  }).then(r=>r.json()).then(j=>{
    if(!j.ok) throw new Error(j.error);
    document.getElementById('msg').textContent='Listing created: '+j.result.listingId;
  }).catch(e=> document.getElementById('msg').textContent='Error: '+e.message);
}
</script>
<div id="g_id_onload" data-client_id="1052887487165-endmh7ktojtd2eehnjt2bf3shcd4abf4.apps.googleusercontent.com" data-callback="onGoogleSignIn"></div>
<div class="g_id_signin" data-type="standard"></div>
<script src="https://www.google.com/recaptcha/api.js?render=6LdjcAgsAAAAABWoHl5dmFjbJQL61kOu7ddvkUZF"></script>
</body></html>