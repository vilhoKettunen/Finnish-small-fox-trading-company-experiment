html vintage story\Finnish-small-fox-trading-company\index.html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Vak Store Trading Calculator</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1100px;
            margin: auto;
        }

        h1, h2, h3 {
            color: #333;
        }

        .section {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            position: relative;
            background: #fff;
        }

        select, input[type="number"], input[list], input[type="text"], button {
            padding: 6px;
            margin: 6px 0;
        }

        ul {
            margin-top: 10px;
            padding-left: 18px;
        }

        .result {
            margin-top: 10px;
            font-weight: bold;
        }

        .payRow {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

            /* limit only numeric inputs inside payRow ‚Äî dropdown text inputs keep their normal width */
            .payRow input[type="number"] {
                width: 60px;
            }

        .negative {
            color: red;
        }

        .positive {
            color: green;
        }

        .more-info-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.8em;
            padding: 4px 8px;
            cursor: pointer;
        }

        .info-box {
            display: none;
            background: #f9f9f9;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            border-radius: 6px;
        }

        li .remove {
            margin-left: 8px;
            color: red;
            cursor: pointer;
        }

        li.payment-item {
            font-style: italic;
        }

        .section ul li a {
            color: #0066cc;
            text-decoration: none;
        }

            .section ul li a:hover {
                text-decoration: underline;
            }

        /* Top bar */
        #topBar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 48px;
            background: #222;
            color: #fff;
            display: none;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            font-size: 14px;
        }

            #topBar a, #topBar button {
                color: #fff;
                text-decoration: none;
                margin-right: 18px;
                background: none;
                border: none;
                cursor: pointer;
            }

            #topBar .right {
                margin-left: auto;
                display: flex;
                gap: 12px;
            }

        body.withTopBar {
            padding-top: 70px;
        }

        /* Custom dropdown list */
        .dropdown-wrap {
            position: relative;
            display: inline-block;
        }

        .dropdown-input {
            width: 250px;
            padding: 6px;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ccc;
            max-height: 220px;
            overflow-y: auto;
            z-index: 500;
            border-radius: 4px;
        }

        .dropdown-item {
            padding: 6px 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

            .dropdown-item:hover {
                background: #f0f6ff;
            }

            /* keyboard-highlighted item */
            .dropdown-item.active {
                background: #dff0ff;
            }

        .stock-circle {
            width: 28px;
            height: 28px;
            flex: 0 0 auto;
        }

        .row-warning-yellow {
            background: #fff8d0;
        }

        .row-warning-red {
            background: #ffd6d6;
        }

        .small-note {
            font-size: 11px;
            color: #a00;
            margin-left: 8px;
        }

        /* OCM subsection styling */
        .ocm-box {
            border: 1px dashed #999;
            padding: 10px;
            margin-top: 10px;
            border-radius: 6px;
            background: #fcfcfc;
        }

        .ocm-listing {
            font-size: 13px;
            margin: 2px 0;
        }

        .highlight-action {
            background: #e9f7ff;
        }

        .copy-btn {
            font-size: 12px;
            padding: 4px 6px;
        }

        #authPanel {
            margin-bottom: 20px;
        }

        #setupForm {
            display: none;
            margin-top: 10px;
        }

        #requestControls {
            margin-top: 20px;
        }

        .inline {
            display: inline-block;
        }

        @media (max-width: 700px) {
            .dropdown-input {
                width: 180px;
            }
        }
    </style>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://www.google.com/recaptcha/api.js?render=6LdjcAgsAAAAABWoHl5dmFjbJQL61kOu7ddvkUZF"></script>
</head>
<body>

    <div id="topBar">
        <div><strong>Vak Store</strong></div>
        <a id="historyLink" href="#" onclick="openHistory()">Account History</a>
        <a id="ocmHomeLink" href="#" onclick="openOCM()">OCM</a>
        <div class="right">
            <button onclick="logout()">Logout</button>
        </div>
    </div>

    <div id="authPanel">
        <div id="g_id_onload"
             data-client_id="1052887487165-endmh7ktojtd2eehnjt2bf3shcd4abf4.apps.googleusercontent.com"
             data-context="signin"
             data-callback="onGoogleSignIn"
             data-auto_select="false"
             data-itp_support="true"></div>

        <div class="g_id_signin"
             data-type="standard"
             data-size="large"
             data-theme="outline"
             data-text="sign_in_with"
             data-shape="rectangular"
             data-logo_alignment="left"></div>

        <div id="loginStatus"></div>

        <div id="setupForm">
            <h3>Account Setup</h3>
            <label>
                Player Name:
                <input type="text" id="setupPlayerName">
            </label><br>
            <label>
                Mailbox (e.g. 1A / 2B / F1):
                <input type="text" id="setupMailbox" placeholder="Format: RowSegment / DepthSegment / FloorSegment">
            </label><br>
            <button onclick="submitSetup()">Save Setup</button>
            <div id="setupMsg"></div>
        </div>
    </div>

    <h1>üõí Vak Store Trading Calculator</h1>

    <!-- Existing sections retained below -->

    <div class="section">
        <label for="currencyInput"><b>Display Currency:</b></label>
        <input id="currencyInput" list="currencyDatalist" placeholder="Search currency / item (type part of name)" />
        <input id="currencySelect" type="hidden" value="BT" />
        <datalist id="currencyDatalist"></datalist>
    </div>

    <!-- Quick calculators (unchanged) -->
    <div class="section">
        <h2>üîπ Quick Individual Item Calculator</h2>
        <button class="more-info-btn" onclick="toggleInfo('quickInfo')">More Info</button>
        <div id="quickInfo" class="info-box">
            <p>Quick calc for a stack or individual item. Pick item and qty to see buy & sell totals.</p>
            <button onclick="toggleInfo('quickInfo')">‚ùå Close</button>
        </div>
        <div>
            <label>Select Full Stack Item:</label>
            <div class="dropdown-wrap">
                <input id="quickStackSelect" class="dropdown-input" placeholder="Type to search stack item">
                <div id="quickStackSelectList" class="dropdown-list" style="display:none;"></div>
            </div>
            <input type="number" id="quickStackQty" value="1" min="1">
            <button onclick="quickStackCalc()">Calculate Stack</button>
            <div id="quickStackResult" class="result"></div>
        </div>
        <div>
            <label>Select Individual Item:</label>
            <div class="dropdown-wrap">
                <input id="quickIndivSelect" class="dropdown-input" placeholder="Type to search indiv item">
                <div id="quickIndivSelectList" class="dropdown-list" style="display:none;"></div>
            </div>
            <input type="number" id="quickIndivQty" value="1" min="1">
            <button onclick="quickIndivCalc()">Calculate Individual</button>
            <div id="quickIndivResult" class="result"></div>
        </div>
    </div>

    <!-- Buy Multiple Items -->
    <div class="section" id="buySection">
        <h2>üîπ Buy Multiple Items</h2>
        <button class="more-info-btn" onclick="toggleInfo('buyInfo')">More Info</button>
        <div id="buyInfo" class="info-box">
            <p>Add stacks/individuals you want to buy. Includes OCM listings if desired.</p>
            <button onclick="toggleInfo('buyInfo')">‚ùå Close</button>
        </div>

        <h3>Full Stacks (Store)</h3>
        <div class="dropdown-wrap">
            <input id="stackSelect" class="dropdown-input" placeholder="Search stack item">
            <div id="stackSelectList" class="dropdown-list" style="display:none;"></div>
        </div>
        <input type="number" id="stackQty" value="1" min="1">
        <button onclick="addStack()">Add Stack</button>

        <h3>Individual Items (Store)</h3>
        <div class="dropdown-wrap">
            <input id="indivSelect" class="dropdown-input" placeholder="Search individual item">
            <div id="indivSelectList" class="dropdown-list" style="display:none;"></div>
        </div>
        <input type="number" id="indivQty" value="1" min="1">
        <button onclick="addIndividual()">Add Individual</button>

        <div class="ocm-box">
            <h3>OCM Listings (Buy)</h3>
            <input type="text" id="ocmBuyQuery" placeholder="Search OCM items">
            <button onclick="refreshOCMBuy()">Search</button>
            <div id="ocmBuyListings"></div>
            <label>
                Quantity:
                <input type="number" id="ocmBuyQty" value="1" min="1">
            </label>
            <button onclick="addOCMBuy()">Add OCM Item</button>
        </div>

        <h3>Account Balance</h3>
        <label>
            Enter Balance (BT):
            <input type="number" id="buyAccountBalanceInput" value="0">
        </label>
        <button onclick="addBuyAccountBalance()">‚ûï Add Balance</button>

        <h3>Custom Inputs (Store)</h3>
        <div>
            <strong>From Spreadsheet ‚Äî Stack</strong><br>
            <div class="dropdown-wrap">
                <input id="customBuyStackSelect" class="dropdown-input" placeholder="Item name">
                <div id="customBuyStackSelectList" class="dropdown-list" style="display:none;"></div>
            </div>
            <input type="number" id="customBuyStackQty" placeholder="Quantity" min="1">
            <input type="number" id="customBuyStackPrice" placeholder="Price per Stack" step="0.01">
            <button onclick="addCustomBuyStack()">Add Custom Stack</button>
        </div>
        <div>
            <strong>From Spreadsheet ‚Äî Individual</strong><br>
            <div class="dropdown-wrap">
                <input id="customBuyIndivSelect" class="dropdown-input" placeholder="Item name">
                <div id="customBuyIndivSelectList" class="dropdown-list" style="display:none;"></div>
            </div>
            <input type="number" id="customBuyIndivQty" placeholder="Quantity" min="1">
            <input type="number" id="customBuyIndivPrice" placeholder="Price per Each" step="0.01">
            <button onclick="addCustomBuyIndividual()">Add Custom Individual</button>
        </div>
        <div>
            <strong>Fully Custom</strong><br>
            <input type="text" id="customBuyName" placeholder="Name">
            <input type="number" id="customBuyQty" placeholder="Quantity (pieces)" min="1">
            <input type="number" id="customBuyStackSize" placeholder="Stack size (pieces per stack)" min="1">
            <input type="number" id="customBuyPrice" placeholder="Price per Stack" step="0.01">
            <button onclick="addFullyCustomBuy()">Add Fully Custom</button>
        </div>
        <ul id="buyList"></ul>
        <div id="buyTotalBox" class="negative">Buy Total: <span id="buyTotal">0.00</span> </div>
    </div>

    <!-- Sell Multiple Items -->
    <div class="section" id="sellSection">
        <h2>üîπ Sell Multiple Items</h2>
        <button class="more-info-btn" onclick="toggleInfo('sellInfo')">More Info</button>
        <div id="sellInfo" class="info-box">
            <p>Add items you sell. Includes OCM interaction and Pay With.</p>
            <button onclick="toggleInfo('sellInfo')">‚ùå Close</button>
        </div>

        <h3>Full Stacks (Store)</h3>
        <div class="dropdown-wrap">
            <input id="sellStackSelect" class="dropdown-input" placeholder="Search stack item">
            <div id="sellStackSelectList" class="dropdown-list" style="display:none;"></div>
        </div>
        <input type="number" id="sellStackQty" value="1" min="1">
        <button onclick="addSellStack()">Add Stack</button>

        <h3>Individual Items (Store)</h3>
        <div class="dropdown-wrap">
            <input id="sellIndivSelect" class="dropdown-input" placeholder="Search individual item">
            <div id="sellIndivSelectList" class="dropdown-list" style="display:none;"></div>
        </div>
        <input type="number" id="sellIndivQty" value="1" min="1">
        <button onclick="addSellIndividual()">Add Individual</button>

        <div class="ocm-box">
            <h3>OCM Listings (Sell)</h3>
            <input type="text" id="ocmSellQuery" placeholder="Search OCM items">
            <button onclick="refreshOCMSell()">Search</button>
            <div id="ocmSellListings"></div>
            <label>
                Quantity:
                <input type="number" id="ocmSellQty" value="1" min="1">
            </label>
            <button onclick="addOCMSell()">Add OCM Item</button>
        </div>

        <h3>Account Balance</h3>
        <label>
            Enter Balance (BT):
            <input type="number" id="accountBalanceInput" value="0">
        </label>
        <button onclick="addAccountBalance()">‚ûï Add Balance</button>

        <h3>Custom Inputs (Store)</h3>
        <div>
            <strong>From Spreadsheet ‚Äî Stack</strong><br>
            <div class="dropdown-wrap">
                <input id="customSellStackSelect" class="dropdown-input" placeholder="Item name">
                <div id="customSellStackSelectList" class="dropdown-list" style="display:none;"></div>
            </div>
            <input type="number" id="customSellStackQty" placeholder="Quantity" min="1">
            <input type="number" id="customSellStackPrice" placeholder="Price per Stack" step="0.01">
            <button onclick="addCustomSellStack()">Add Custom Stack</button>
        </div>
        <div>
            <strong>From Spreadsheet ‚Äî Individual</strong><br>
            <div class="dropdown-wrap">
                <input id="customSellIndivSelect" class="dropdown-input" placeholder="Item name">
                <div id="customSellIndivSelectList" class="dropdown-list" style="display:none;"></div>
            </div>
            <input type="number" id="customSellIndivQty" placeholder="Quantity" min="1">
            <input type="number" id="customSellIndivPrice" placeholder="Price per Each" step="0.01">
            <button onclick="addCustomSellIndividual()">Add Custom Individual</button>
        </div>
        <div>
            <strong>Fully Custom</strong><br>
            <input type="text" id="customSellName" placeholder="Name">
            <input type="number" id="customSellQty" placeholder="Quantity (pieces)" min="1">
            <input type="number" id="customSellStackSize" placeholder="Stack size (pieces per stack)" min="1">
            <input type="number" id="customSellPrice" placeholder="Price per Stack" step="0.01">
            <button onclick="addFullyCustomSell()">Add Fully Custom</button>
        </div>
        <ul id="sellList"></ul>
        <div id="sellTotalBox" class="positive">Sell Total: <span id="sellTotal">0.00</span> </div>
    </div>

    <!-- Combined Totals -->
    <div class="section">
        <h2>üîπ Combined Totals</h2>
        <button class="more-info-btn" onclick="toggleInfo('combinedInfo')">More Info</button>
        <div id="combinedInfo" class="info-box">
            <p>Net Balance: sell - buy (fees applied at approval if admin executes sale).</p>
            <button onclick="toggleInfo('combinedInfo')">‚ùå Close</button>
        </div>
        <div id="combinedTotalBox">Net Balance: <span id="netTotal">0.00</span> </div>
    </div>

    <!-- Pay With -->
    <div class="section">
        <h2>üîπ Pay With</h2>
        <button class="more-info-btn" onclick="toggleInfo('payInfo')">More Info</button>
        <div id="payInfo" class="info-box">
            <p>Select items to cover negative net. Items added to Sell receipt.</p>
            <button onclick="toggleInfo('payInfo')">‚ùå Close</button>
        </div>

        <div id="payOptions"></div>
        <button onclick="addPayRow()">‚ûï Add Item</button>
        <ul id="payList"></ul>
        <button onclick="calculatePayment()">Calculate Payment</button>
        <div id="paymentResult" class="result"></div>
    </div>

    <!-- Item Converter -->
    <div class="section">
        <h2>üîπ Item Converter</h2>
        <button class="more-info-btn" onclick="toggleInfo('converterInfo')">More Info</button>
        <div id="converterInfo" class="info-box">
            <p>Allocate % of positive Net Balance into items (added to Buy receipt).</p>
            <button onclick="toggleInfo('converterInfo')">‚ùå Close</button>
        </div>

        <div id="converterOptions"></div>
        <button onclick="addConverterRow()">‚ûï Add Item</button>
        <ul id="converterListDisplay"></ul>
        <button onclick="calculateConversion()">Convert Balance</button>
        <div id="converterResult" class="result"></div>
    </div>

    <!-- Request Controls -->
    <div id="requestControls" class="section" style="display:none;">
        <h2>üîπ Transaction Request</h2>
        <button onclick="submitPurchaseRequest()">Submit Purchase Request</button>
        <button class="copy-btn" onclick="copyTransactionData()">Copy Transaction Data</button>
        <div id="requestMsg"></div>
    </div>

    <!-- Links Section -->
    <div class="section">
        <h2>üîó Useful Links</h2>
        <ul>
            <li><a href="https://translocator.moe/" target="_blank">TL route calculator</a></li>
            <li><a href="https://map.tops.vintagestory.at/?x=-419&y=416&zoom=6" target="_blank">TOPS map</a></li>
            <li><a href="https://wiki.vintagestory.at/Main_Page" target="_blank">Wiki</a></li>
            <li><a href="https://docs.google.com/spreadsheets/d/1W9ByTiwX3lPakqoYXTHgnOiMNNzwSVnkgmTPqvMrSUc/edit?gid=0#gid=0" target="_blank">Mailbox names</a></li>
            <li><a href="https://docs.google.com/spreadsheets/d/1_meliJtuKSDwEWRDh1gldcsD-pSjDgIND3dcE1mCjCo/edit?gid=0#gid=0" target="_blank">PRICE SHEET</a></li>
            <li><a href="https://www.vintagestory.at/" target="_blank">Vintage Story official website</a></li>
            <li><a href="https://mods.vintagestory.at/" target="_blank">Vintage Story official mods page</a></li>
            <li><a href="BTIncurance.html" target="_blank">BT Insurance</a></li>
            <li><a href="PriceHistory.html" target="_blank">Price History</a></li>
            <li><a href="VintageStoryEconomics.html" target="_blank">Vintage Story Economics</a></li>
        </ul>
    </div>

    <script>
        /* ===== CONFIG ===== */
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbygL-uqAGe0HSBDVdnF_HlszWQcCJQ_TyikxqvYrgnRsY7SFXcqd6mI3DhMfp3sLZIBXQ/exec';
        const RECAPTCHA_SITE_KEY = '6LdjcAgsAAAAABWoHl5dmFjbJQL61kOu7ddvkUZF';
        const OAUTH_CLIENT_ID = '1052887487165-endmh7ktojtd2eehnjt2bf3shcd4abf4.apps.googleusercontent.com';

        const sheetURL = "https://docs.google.com/spreadsheets/d/1_meliJtuKSDwEWRDh1gldcsD-pSjDgIND3dcE1mCjCo/gviz/tq?tqx=out:json&gid=0";
        // Editor-friendly sheet link for reference: https://docs.google.com/spreadsheets/d/1_meliJtuKSDwEWRDh1gldcsD-pSjDgIND3dcE1mCjCo/edit?gid=0#gid=0

        let items = [], payItems = [], buyCart = [], sellCart = [];
        let stockProgressCache = []; // {name, currentEach, targetEach, pct}
        let currentUser = null;
        let googleIdToken = null;
        const BASE_CURRENCY = "BT";

        // Global dropdown data used by all searchable inputs (kept up-to-date by setupDropdowns)
        let dropdownData = [];

        /* ===== Google Login ===== */
        function onGoogleSignIn(resp) {
            googleIdToken = resp && resp.credential;
            const statusEl = document.getElementById('loginStatus');

            if (!googleIdToken) {
                statusEl.textContent = 'Login error: no credential returned';
                console.error('onGoogleSignIn: no credential in resp', resp);
                return;
            }

            statusEl.textContent = 'Logged in. Validating token...';

            (async () => {
                try {
                    const tokenInfoUrl = `https://oauth2.googleapis.com/tokeninfo?id_token=${encodeURIComponent(googleIdToken)}`;
                    console.log('Fetching tokeninfo:', tokenInfoUrl);
                    const tResp = await fetch(tokenInfoUrl);
                    if (!tResp.ok) {
                        const body = await tResp.text().catch(() => '<no body>');
                        throw new Error(`tokeninfo fetch failed: status=${tResp.status} body=${body}`);
                    }
                    const info = await tResp.json();
                    console.log('tokeninfo:', info);

                    if (info.aud !== OAUTH_CLIENT_ID) {
                        throw new Error(`Invalid audience (got: ${info.aud}). Expected: ${OAUTH_CLIENT_ID}`);
                    }

                    statusEl.textContent = 'Token audience OK. Fetching profile from backend...';

                    const backendUrl = `${WEB_APP_URL}?action=me&idToken=${encodeURIComponent(googleIdToken)}`;
                    console.log('Fetching backend:', backendUrl);
                    const bResp = await fetch(backendUrl);
                    if (!bResp.ok) {
                        const body = await bResp.text().catch(() => '<no body>');
                        throw new Error(`backend fetch failed: status=${bResp.status} body=${body}`);
                    }
                    const j = await bResp.json();
                    if (!j.ok) throw new Error('Backend returned error: ' + (j.error || JSON.stringify(j)));

                    currentUser = j.data.user;
                    if (!currentUser || !currentUser.playerName) {
                        document.getElementById('setupForm').style.display = 'block';
                    } else {
                        document.getElementById('setupForm').style.display = 'none';
                        enableAppUI();
                    }
                    showTopBar();
                    statusEl.textContent = 'Logged in.';
                } catch (err) {
                    // Differentiate network vs other
                    const msg = err && err.message ? err.message : String(err);
                    statusEl.textContent = 'Login error: ' + msg;
                    console.error('onGoogleSignIn error detail:', err);
                }
            })();
        }

        function logout() {
            googleIdToken = null;
            currentUser = null;
            document.getElementById('loginStatus').textContent = 'Logged out.';
            document.getElementById('topBar').style.display = 'none';
            document.body.classList.remove('withTopBar');
            document.getElementById('requestControls').style.display = 'none';
        }

        function submitSetup() {
            const playerName = document.getElementById('setupPlayerName').value.trim();
            const mailbox = document.getElementById('setupMailbox').value.trim();
            if (!playerName || !mailbox) {
                document.getElementById('setupMsg').textContent = 'Player name and mailbox required';
                return;
            }
            recaptchaWrap().then(token => {
                return fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'linkPlayer',
                        idToken: googleIdToken,
                        recaptchaToken: token,
                        payload: { playerName, mailbox }
                    })
                });
            })
                .then(r => r.json())
                .then(j => {
                    if (!j.ok) throw new Error(j.error);
                    document.getElementById('setupMsg').textContent = 'Setup complete.';
                    // re-fetch me:
                    return fetch(`${WEB_APP_URL}?action=me&idToken=${encodeURIComponent(googleIdToken)}`);
                })
                .then(r => r.json())
                .then(j => {
                    currentUser = j.data.user;
                    enableAppUI();
                    showTopBar();
                    document.getElementById('setupForm').style.display = 'none';
                })
                .catch(e => {
                    document.getElementById('setupMsg').textContent = 'Error: ' + e.message;
                });
        }

        function enableAppUI() {
            document.getElementById('requestControls').style.display = 'block';
        }

        function showTopBar() {
            if (googleIdToken && currentUser) {
                document.getElementById('topBar').style.display = 'flex';
                document.body.classList.add('withTopBar');
            }
        }

        /* ===== reCAPTCHA helper ===== */
        function recaptchaWrap() {
            return new Promise((resolve, reject) => {
                grecaptcha.ready(() => {
                    grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'submit' }).then(resolve).catch(reject);
                });
            });
        }

        /* ===== Custom dropdown rendering + keyboard nav ===== */
        function attachDropdown(inputId, listId, filterFn, selectCallback) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            if (!input || !list) return;

            // helper to set active index
            function setActiveIndex(idx) {
                const items = Array.from(list.querySelectorAll('.dropdown-item'));
                items.forEach(it => it.classList.remove('active'));
                if (idx >= 0 && idx < items.length) {
                    items[idx].classList.add('active');
                    items[idx].scrollIntoView({ block: 'nearest' });
                    input._dropIndex = idx;
                } else {
                    input._dropIndex = -1;
                }
            }

            function renderAndShow() {
                const q = (input.value || "").toLowerCase();
                const filtered = filterFn(q);
                renderDropdownList(list, filtered, (val) => {
                    input.value = val;
                    list.style.display = 'none';
                    input._dropIndex = -1;
                    if (selectCallback) selectCallback(val);
                });
                // reset index
                input._dropIndex = -1;
                const items = list.querySelectorAll('.dropdown-item');
                if (items.length) {
                    list.style.display = 'block';
                } else {
                    list.style.display = 'none';
                }
            }

            input.addEventListener('input', renderAndShow);
            input.addEventListener('focus', renderAndShow);

            input.addEventListener('keydown', (ev) => {
                const itemsEls = Array.from(list.querySelectorAll('.dropdown-item'));
                if (!itemsEls.length) return;
                if (ev.key === 'ArrowDown') {
                    ev.preventDefault();
                    const idx = Math.min((input._dropIndex || -1) + 1, itemsEls.length - 1);
                    setActiveIndex(idx);
                } else if (ev.key === 'ArrowUp') {
                    ev.preventDefault();
                    const idx = Math.max((input._dropIndex || -1) - 1, 0);
                    setActiveIndex(idx);
                } else if (ev.key === 'Enter') {
                    if (typeof input._dropIndex === 'number' && input._dropIndex >= 0) {
                        ev.preventDefault();
                        itemsEls[input._dropIndex].click();
                    } else {
                        // let Enter behave normally (e.g. submit) if nothing selected
                    }
                } else if (ev.key === 'Escape') {
                    list.style.display = 'none';
                    input._dropIndex = -1;
                }
            });

            input.addEventListener('blur', () => {
                // small delay so click handlers can run
                setTimeout(() => {
                    list.style.display = 'none';
                    input._dropIndex = -1;
                }, 200);
            });
        }

        function renderDropdownList(container, arr, onSelect) {
            container.innerHTML = '';
            arr.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                div.dataset.index = String(idx);

                // stock circle:
                const prog = stockProgressCache.find(sp => sp.name === item.name);
                const pct = prog ? prog.pct : 0;
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                circle.setAttribute('class', 'stock-circle');
                circle.setAttribute('viewBox', '0 0 36 36');
                const bg = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                bg.setAttribute('cx', '18'); bg.setAttribute('cy', '18'); bg.setAttribute('r', '16');
                bg.setAttribute('stroke', '#eee'); bg.setAttribute('stroke-width', '4'); bg.setAttribute('fill', 'none');
                const fg = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                fg.setAttribute('cx', '18'); fg.setAttribute('cy', '18'); fg.setAttribute('r', '16');
                fg.setAttribute('stroke', pct >= 100 ? '#3cb371' : '#2196f3'); fg.setAttribute('stroke-width', '4'); fg.setAttribute('fill', 'none');
                fg.setAttribute('stroke-dasharray', Math.round((pct / 100) * 2 * Math.PI * 16) + ',1000');
                fg.setAttribute('transform', 'rotate(-90 18 18)');
                circle.appendChild(bg); circle.appendChild(fg);

                const label = document.createElement('div');
                label.innerHTML = `<strong>${item.name}</strong><br><small>${item.extra}</small>`;

                div.appendChild(circle);
                div.appendChild(label);

                div.addEventListener('mouseover', () => {
                    // highlight when hovering
                    const siblings = Array.from(container.querySelectorAll('.dropdown-item'));
                    siblings.forEach(s => s.classList.remove('active'));
                    div.classList.add('active');
                });

                div.onclick = () => onSelect(item.name);
                container.appendChild(div);
            });
        }

        /* ===== Existing loadData (adapted) ===== */
        function loadData() {
            fetch(sheetURL)
                .then(r => {
                    if (!r.ok) throw new Error(`Fetch failed: ${r.status}`);
                    return r.text();
                })
                .then(t => {
                    let payloadText = t;
                    const start = payloadText.indexOf('(');
                    const end = payloadText.lastIndexOf(')');
                    if (start > -1 && end > start) payloadText = payloadText.slice(start + 1, end);
                    const json = JSON.parse(payloadText);
                    const rows = json?.table?.rows || [];

                    // parse items with expected columns:
                    // A: name (0), B: buyStack (1), C: sellStack (2), D: stackStock (3),
                    // E: bundleSize (4), F: buyEach (5), G: sellEach (6), H: indivStock (7), I: availPercent (8), J: targetEach (9)
                    items = rows.map(row => {
                        const c = row.c || [];
                        const name = c[0]?.v ?? "";
                        const buyStack = c[1]?.v ?? "";
                        const sellStack = c[2]?.v ?? "";
                        const stackStock = Number(c[3]?.v ?? 0);
                        const bundleSize = Number(c[4]?.v ?? 1);
                        const buyEach = c[5]?.v ?? "";
                        const sellEach = c[6]?.v ?? "";
                        const indivStock = Number(c[7]?.v ?? 0);
                        const availPercent = Number(c[8]?.v ?? 0);
                        const targetEach = Number(c[9]?.v ?? 0); // J column = targetEach
                        if (!name) return null;
                        if ((buyStack === "X" && sellStack === "X") && (buyEach === "X" && sellEach === "X")) return null;
                        const parseNumOrNull = (v) => {
                            if (v === null || v === "" || v === undefined) return null;
                            const n = Number(v); return isNaN(n) ? null : n;
                        };
                        return {
                            name: String(name),
                            bundleSize: bundleSize || 1,
                            stackStock,
                            indivStock,
                            availPercent,
                            targetEach: targetEach || 0,
                            buyStack: parseNumOrNull(buyStack),
                            sellStack: parseNumOrNull(sellStack),
                            buyEach: parseNumOrNull(buyEach),
                            sellEach: parseNumOrNull(sellEach)
                        };
                    }).filter(Boolean);

                    // Build stock progress cache from the same sheet (D = stackStock, H = indivStock, E = bundleSize, J = targetEach)
                    stockProgressCache = items.map(i => {
                        const currentEach = (Number(i.stackStock || 0) * Number(i.bundleSize || 1)) + Number(i.indivStock || 0);
                        const targetEach = Number(i.targetEach || 0);
                        const pct = targetEach > 0 ? Math.round((currentEach / targetEach) * 100) : 0;
                        return { name: i.name, currentEach, targetEach, pct };
                    });

                    payItems = items.slice();
                    populateCurrencyDatalist();
                    setupDropdowns();
                })
                .catch(err => {
                    console.error('Failed to load sheet:', err);
                    items = [];
                    payItems = [];
                    stockProgressCache = [];
                    populateCurrencyDatalist();
                    setupDropdowns();
                });
        }

        function populateCurrencyDatalist() {
            const currencyDatalist = document.getElementById("currencyDatalist");
            currencyDatalist.innerHTML = "";
            currencyDatalist.appendChild(new Option(BASE_CURRENCY, BASE_CURRENCY));
            items.forEach(i => {
                const currencyLabel = `${i.name} ‚Äî stack:${i.stackStock} each:${i.indivStock} avail:${i.availPercent}%`;
                currencyDatalist.appendChild(new Option(currencyLabel, i.name));
            });
            const input = document.getElementById("currencyInput");
            const hidden = document.getElementById("currencySelect");
            input.onchange = () => {
                const val = input.value.trim();
                if (!val) hidden.value = BASE_CURRENCY;
                else {
                    const exact = items.find(it => it.name.toLowerCase() === val.toLowerCase());
                    hidden.value = exact ? exact.name : BASE_CURRENCY;
                }
                updateAllDisplays();
            };
            input.oninput = () => {
                const v = input.value.trim();
                const exact = items.find(it => it.name.toLowerCase() === v.toLowerCase());
                if (exact) {
                    hidden.value = exact.name;
                    updateAllDisplays();
                }
            };
        }

        /* ===== Dropdown Setup ===== */
        function setupDropdowns() {
            // Build dropdownData used by all searchable inputs
            dropdownData = items.map(i => {
                let extra = `stkStock:${i.stackStock} eachStock:${i.indivStock} avail:${i.availPercent}%`;
                return { name: i.name, extra };
            });

            function filterBy(q) {
                if (!q) return dropdownData.slice(0, 200); // show some results
                return dropdownData.filter(d => d.name.toLowerCase().includes(q));
            }

            // Attach to static inputs
            attachDropdown('quickStackSelect', 'quickStackSelectList', (q) => filterBy(q), (v) => { });
            attachDropdown('quickIndivSelect', 'quickIndivSelectList', (q) => filterBy(q), (v) => { });
            attachDropdown('stackSelect', 'stackSelectList', (q) => filterBy(q), (v) => { });
            attachDropdown('indivSelect', 'indivSelectList', (q) => filterBy(q), (v) => { });
            attachDropdown('sellStackSelect', 'sellStackSelectList', (q) => filterBy(q), (v) => { });
            attachDropdown('sellIndivSelect', 'sellIndivSelectList', (q) => filterBy(q), (v) => { });

            // Attach to custom (spreadsheet) static inputs
            attachDropdown('customBuyStackSelect', 'customBuyStackSelectList', (q) => filterBy(q), (v) => { });
            attachDropdown('customBuyIndivSelect', 'customBuyIndivSelectList', (q) => filterBy(q), (v) => { });
            attachDropdown('customSellStackSelect', 'customSellStackSelectList', (q) => filterBy(q), (v) => { });
            attachDropdown('customSellIndivSelect', 'customSellIndivSelectList', (q) => filterBy(q), (v) => { });
        }

        /* ===== OCM (basic read & cart add stubs) ===== */
        let ocmListingsCacheBuy = [];
        let ocmListingsCacheSell = [];

        function refreshOCMBuy() {
            const q = document.getElementById('ocmBuyQuery').value.trim();
            fetch(`${WEB_APP_URL}?action=listings&q=${encodeURIComponent(q)}`)
                .then(r => r.json())
                .then(j => {
                    if (!j.ok) throw new Error(j.error);
                    ocmListingsCacheBuy = j.data.filter(l => l.type === 'SELL');
                    renderOCMListings('ocmBuyListings', ocmListingsCacheBuy);
                })
                .catch(e => {
                    document.getElementById('ocmBuyListings').textContent = 'Error: ' + e.message;
                });
        }

        function refreshOCMSell() {
            const q = document.getElementById('ocmSellQuery').value.trim();
            fetch(`${WEB_APP_URL}?action=listings&q=${encodeURIComponent(q)}`)
                .then(r => r.json())
                .then(j => {
                    if (!j.ok) throw new Error(j.error);
                    ocmListingsCacheSell = j.data.filter(l => l.type === 'BUY');
                    renderOCMListings('ocmSellListings', ocmListingsCacheSell);
                })
                .catch(e => {
                    document.getElementById('ocmSellListings').textContent = 'Error: ' + e.message;
                });
        }

        function renderOCMListings(containerId, arr) {
            const el = document.getElementById(containerId);
            el.innerHTML = '';
            if (!arr.length) { el.textContent = 'No listings'; return; }
            arr.forEach(l => {
                const div = document.createElement('div');
                div.className = 'ocm-listing';
                div.textContent = `${l.itemName} | ${l.type} | ${l.unit} | price:${l.priceBT} | qty:${l.qtyAvailable || '‚àû'} | by ${l.playerName}`;
                div.dataset.listingId = l.listingId;
                div.onclick = () => {
                    // mark selection
                    Array.from(el.children).forEach(c => c.classList.remove('highlight-action'));
                    div.classList.add('highlight-action');
                    el.dataset.selectedListingId = l.listingId;
                };
                el.appendChild(div);
            });
        }

        function addOCMBuy() {
            const container = document.getElementById('ocmBuyListings');
            const id = container.dataset.selectedListingId;
            if (!id) { alert('Select an OCM SELL listing first'); return; }
            const listing = ocmListingsCacheBuy.find(l => l.listingId === id);
            if (!listing) return;
            const qty = parseInt(document.getElementById('ocmBuyQty').value) || 0;
            if (qty <= 0) return;
            // Treat as store purchase source OCM
            buyCart.push({ name: listing.itemName, qty, price: Number(listing.priceBT), source: 'OCM', listingId: id });
            renderBuyList();
        }

        function addOCMSell() {
            const container = document.getElementById('ocmSellListings');
            const id = container.dataset.selectedListingId;
            if (!id) { alert('Select an OCM BUY listing first'); return; }
            const listing = ocmListingsCacheSell.find(l => l.listingId === id);
            if (!listing) return;
            const qty = parseInt(document.getElementById('ocmSellQty').value) || 0;
            if (qty <= 0) return;
            // Treat as selling to OCM buyer
            sellCart.push({ name: listing.itemName, qty, price: Number(listing.priceBT), source: 'OCM', listingId: id });
            renderSellList();
        }

        /* ===== Row coloring against stock & target ===== */
        function evaluateRowColorBuy(entry) {
            // Compare qty wanted vs current stock (use sheet-derived currentEach)
            const prog = stockProgressCache.find(sp => sp.name === entry.name);
            const item = items.find(i => i.name === entry.name);
            if (!prog && !item) return null;
            if (entry.source === 'OCM') return null;
            const currentEach = prog ? prog.currentEach : ((item.stackStock || 0) * (item.bundleSize || 1) + (item.indivStock || 0));
            const eachRequested = entry.bundleSize ? entry.qty * entry.bundleSize : entry.qty;
            if (currentEach <= 0) return 'row-warning-red';
            const ratio = eachRequested / currentEach;
            if (ratio > 1) return 'row-warning-red';
            if (ratio > 0.5) return 'row-warning-yellow';
            return null;
        }

        function evaluateRowColorSell(entry) {
            // Over target check: (sell qty + current stock D) > target J
            const prog = stockProgressCache.find(sp => sp.name === entry.name);
            if (!prog || entry.source === 'OCM') return null;
            const eachSelling = entry.bundleSize ? entry.qty * entry.bundleSize : entry.qty;
            const projected = prog.currentEach + eachSelling;
            if (prog.targetEach > 0 && projected > prog.targetEach) return 'row-warning-red';
            return null;
        }

        /* ===== Currency conversion helpers ===== */
        function convertValue(btValue, currencyName, forBuySection) {
            if (!currencyName || currencyName === BASE_CURRENCY) return { bt: btValue, converted: null };
            const currency = items.find(i => i.name.toLowerCase() === currencyName.toLowerCase());
            if (!currency) return { bt: btValue, converted: null };
            const rate = forBuySection
                ? (currency.buyEach || currency.buyStack || 0)
                : (currency.sellEach || currency.sellStack || 0);
            if (!rate || rate <= 0) return { bt: btValue, converted: null };
            return { bt: btValue, converted: btValue / rate };
        }
        function formatValue(btValue, currencyName, forBuySection) {
            if (isNaN(btValue)) btValue = 0;
            let txt = `${btValue.toFixed(2)} ${BASE_CURRENCY}`;
            if (currencyName && currencyName !== BASE_CURRENCY) {
                const { converted } = convertValue(btValue, currencyName, !!forBuySection);
                if (converted != null && !isNaN(converted)) {
                    txt += ` (‚âà ${converted.toFixed(2)} ${currencyName})`;
                }
            }
            return txt;
        }
        function updateAllDisplays() {
            renderBuyList();
            renderSellList();
            calculateNet();
        }

        /* ===== Existing rendering logic (extended with row coloring & source tags) ===== */
        function renderBuyList() {
            const list = document.getElementById("buyList");
            list.innerHTML = "";
            let total = 0;
            const curr = document.getElementById("currencySelect").value;

            buyCart.forEach((e) => {
                const li = document.createElement("li");
                let rowTotal = 0;
                let rowText = "";
                if (e.isBalance) {
                    rowTotal = e.price || 0;
                    rowText = `Account Balance: ${rowTotal.toFixed(2)} BT`;
                } else if (e.bundleSize && e.isFullyCustom) {
                    rowTotal = (e.qty / e.bundleSize) * e.price;
                    rowText = `${e.qty} √ó ${e.name} (${e.price.toFixed(2)} BT per ${e.bundleSize}) (${rowTotal.toFixed(2)} BT)`;
                } else if (e.bundleSize) {
                    rowTotal = e.qty * e.price;
                    rowText = `${e.qty} √ó ${e.bundleSize} ${e.name} (${e.price.toFixed(2)} BT stack) (${rowTotal.toFixed(2)} BT)`;
                } else {
                    rowTotal = e.qty * e.price;
                    rowText = `${e.qty} √ó ${e.name} (${e.price.toFixed(2)} BT each) (${rowTotal.toFixed(2)} BT)`;
                }
                total += rowTotal;

                if (e.isConverter) rowText += " [Converted]";
                if (e.source === 'OCM') rowText += " [OCM]";
                const colorClass = evaluateRowColorBuy(e);
                if (colorClass) li.classList.add(colorClass);

                if (curr && curr !== BASE_CURRENCY) {
                    rowText += " " + formatValue(rowTotal, curr, true);
                }
                li.textContent = rowText;
                const removeBtn = document.createElement("button");
                removeBtn.textContent = "‚ùå";
                removeBtn.onclick = () => {
                    buyCart = buyCart.filter(x => x !== e);
                    renderBuyList();
                    calculateNet();
                };
                li.appendChild(removeBtn);
                list.appendChild(li);
            });
            document.getElementById("buyTotal").textContent = formatValue(total, curr, true);
            calculateNet();
        }

        function renderSellList() {
            const list = document.getElementById("sellList");
            list.innerHTML = "";
            let total = 0;
            const curr = document.getElementById("currencySelect").value;

            sellCart.forEach((e) => {
                const li = document.createElement("li");
                let rowTotal = 0;
                let rowText = "";
                if (e.isBalance) {
                    rowTotal = e.price || 0;
                    rowText = `Account Balance: ${rowTotal.toFixed(2)} BT`;
                } else if (e.bundleSize && e.isFullyCustom) {
                    rowTotal = (e.qty / e.bundleSize) * e.price;
                    rowText = `${e.qty} √ó ${e.name} (${e.price} BT per ${e.bundleSize}) (${rowTotal.toFixed(2)} BT)`;
                } else if (e.bundleSize) {
                    rowTotal = e.qty * e.price;
                    rowText = `${e.qty} √ó ${e.bundleSize} ${e.name} (${e.price.toFixed(2)} BT stack) (${rowTotal.toFixed(2)} BT)`;
                } else {
                    rowTotal = e.qty * e.price;
                    rowText = `${e.qty} √ó ${e.name} (${e.price.toFixed(2)} BT each) (${rowTotal.toFixed(2)} BT)`;
                }
                if (e.isPayWith) rowText += " [Pay With]";
                if (e.source === 'OCM') rowText += " [OCM]";

                total += rowTotal;

                const colorClass = evaluateRowColorSell(e);
                if (colorClass) {
                    li.classList.add(colorClass);
                    if (colorClass === 'row-warning-red') {
                        const warn = document.createElement('span');
                        warn.className = 'small-note';
                        warn.textContent = 'over target stock ‚Äî forced recalculation of payment';
                        li.appendChild(warn);
                    }
                }

                if (curr && curr !== BASE_CURRENCY) {
                    rowText += " " + formatValue(rowTotal, curr, false);
                }

                li.textContent = rowText;
                const removeBtn = document.createElement("button");
                removeBtn.textContent = "‚ùå";
                removeBtn.onclick = () => {
                    sellCart = sellCart.filter(x => x !== e);
                    renderSellList();
                    calculateNet();
                };
                li.appendChild(removeBtn);
                list.appendChild(li);
            });
            document.getElementById("sellTotal").textContent = formatValue(total, curr, false);
            calculateNet();
        }

        function calculateNet() {
            let buyTotal = buyCart.reduce((s, e) => {
                if (e.isBalance) return s + (e.price || 0);
                if (e.bundleSize && e.isFullyCustom) return s + ((e.qty / e.bundleSize) * e.price);
                if (e.bundleSize) return s + (e.qty * e.price);
                return s + (e.qty * e.price);
            }, 0);
            let sellTotal = sellCart.reduce((s, e) => {
                if (e.isBalance) return s + (e.price || 0);
                if (e.bundleSize && e.isFullyCustom) return s + ((e.qty / e.bundleSize) * e.price);
                if (e.bundleSize) return s + (e.qty * e.price);
                return s + (e.qty * e.price);
            }, 0);
            const net = sellTotal - buyTotal;
            const curr = document.getElementById("currencySelect").value;
            const netSpan = document.getElementById("netTotal");
            netSpan.dataset.raw = String(net);
            const forBuySection = net < 0;
            netSpan.textContent = formatValue(net, curr, forBuySection);
            netSpan.className = net >= 0 ? "positive" : "negative";
        }

        /* ===== Purchase Request Submission ===== */
        function buildRequestPayload() {
            // Standard schema
            const buyItems = buyCart.map(b => ({
                name: b.name, qty: b.qty, priceBT: b.price, bundleSize: b.bundleSize || null, source: b.source || 'STORE'
            }));
            const sellItems = sellCart.map(s => ({
                name: s.name, qty: s.qty, priceBT: s.price, bundleSize: s.bundleSize || null, source: s.source || 'STORE'
            }));
            const totals = {
                buyBT: buyItems.reduce((s, i) => s + (i.priceBT * (i.bundleSize ? i.qty : i.qty)), 0),
                sellBT: sellItems.reduce((s, i) => s + (i.priceBT * (i.bundleSize ? i.qty : i.qty)), 0)
            };
            totals.netBT = totals.sellBT - totals.buyBT;
            return {
                requestId: cryptoRandomId(),
                createdAt: new Date().toISOString(),
                user: {
                    userId: currentUser?.userId,
                    email: currentUser?.email,
                    playerName: currentUser?.playerName,
                    mailbox: currentUser?.mailbox
                },
                carts: { buy: buyItems, sell: sellItems },
                totals,
                priceSource: { sheetId: 'PRICE_SHEET', asOf: new Date().toISOString() }
            };
        }
        function cryptoRandomId() {
            return (crypto.getRandomValues(new Uint32Array(4))).join('-');
        }
        function submitPurchaseRequest() {
            if (!googleIdToken) { alert('Login first'); return; }
            const payload = buildRequestPayload();
            recaptchaWrap()
                .then(token => {
                    return fetch(WEB_APP_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'createRequest',
                            idToken: googleIdToken,
                            recaptchaToken: token,
                            payload
                        })
                    });
                })
                .then(r => r.json())
                .then(j => {
                    if (!j.ok) throw new Error(j.error);
                    document.getElementById('requestMsg').textContent = 'Request submitted. ID: ' + j.result.requestId;
                })
                .catch(e => {
                    document.getElementById('requestMsg').textContent = 'Error: ' + e.message;
                });
        }

        function copyTransactionData() {
            const payload = buildRequestPayload();
            const txt = JSON.stringify(payload, null, 2);
            navigator.clipboard.writeText(txt)
                .then(() => {
                    document.getElementById('requestMsg').textContent = 'Transaction data copied.';
                })
                .catch(e => {
                    document.getElementById('requestMsg').textContent = 'Copy failed: ' + e.message;
                });
        }

        /* ===== Pay With / Converter (improved dynamic searchable inputs) ===== */
        function addPayRow() {
            const div = document.createElement("div");
            div.className = "payRow";

            // create searchable input + dropdown list inside a proper .dropdown-wrap
            const unique = 'paySelect_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
            const input = document.createElement("input");
            input.id = unique;
            input.className = 'dropdown-input';
            input.placeholder = 'Item name';

            const list = document.createElement("div");
            list.id = unique + 'List';
            list.className = 'dropdown-list';
            list.style.display = 'none';

            // wrapper matching other dropdowns so absolute list positioning works
            const wrap = document.createElement('div');
            wrap.className = 'dropdown-wrap';
            wrap.style.position = 'relative';
            wrap.appendChild(input);
            wrap.appendChild(list);

            const percent = document.createElement("input");
            percent.type = "number"; percent.value = 0; percent.min = 0; percent.max = 100; percent.placeholder = "%";

            const removeRowBtn = document.createElement("button");
            removeRowBtn.type = "button"; removeRowBtn.textContent = "‚ùå";
            removeRowBtn.onclick = () => { div.remove(); calculatePayment(); };

            div.appendChild(wrap);
            div.appendChild(document.createTextNode(" % of total: "));
            div.appendChild(percent);
            div.appendChild(removeRowBtn);
            document.getElementById("payOptions").appendChild(div);

            // attach the dropdown behavior to the dynamic pair
            attachDropdown(input.id, list.id, (q) => {
                const ql = (q || "").toLowerCase();
                if (!ql) return dropdownData.slice(0, 200);
                return dropdownData.filter(d => d.name.toLowerCase().includes(ql));
            }, (val) => { /* no-op callback */ });
        }

        function calculatePayment() {
            const payListEl = document.getElementById("payList");
            payListEl.innerHTML = "";
            const netSpan = document.getElementById("netTotal");
            const netRaw = parseFloat(netSpan.dataset.raw);
            const totalNet = !isNaN(netRaw)
                ? netRaw
                : parseFloat((netSpan.textContent || "0").replace(/[^\d.-]/g, "")) || 0;
            if (totalNet >= 0) {
                document.getElementById("paymentResult").textContent =
                    `‚úÖ Net Balance is ${totalNet.toFixed(2)} BT. No payment needed.`;
                sellCart = sellCart.filter(e => !e.isPayWith);
                renderSellList();
                calculateNet();
                return;
            }
            const owed = -totalNet;
            let usedPercent = 0;
            sellCart = sellCart.filter(e => !e.isPayWith);
            const curr = document.getElementById("currencySelect").value;
            const rows = document.querySelectorAll("#payOptions .payRow");
            rows.forEach(row => {
                const inputEl = row.querySelector('input.dropdown-input');
                const percentEl = row.querySelector('input[type="number"]');
                const rawName = (inputEl?.value || "").trim();
                const percent = parseFloat(percentEl?.value) || 0;
                if (!rawName || percent <= 0) return;
                let item = payItems.find(i => i.name.toLowerCase() === rawName.toLowerCase());
                if (!item) item = payItems.find(i => i.name.toLowerCase().includes(rawName.toLowerCase()));
                if (!item) return;
                usedPercent += percent;
                const portion = (percent / 100) * owed;
                let stackPrice = item.buyStack || (item.buyEach && item.bundleSize ? item.buyEach * item.bundleSize : 0);
                let indivPrice = item.buyEach || (item.buyStack && item.bundleSize ? item.buyStack / item.bundleSize : 0);
                if ((!stackPrice || stackPrice <= 0) && (!indivPrice || indivPrice <= 0)) return;
                let stacks = 0, individuals = 0, leftover = portion;
                if (stackPrice > 0) { stacks = Math.floor(portion / stackPrice); leftover -= stacks * stackPrice; }
                if (indivPrice > 0 && leftover > 0) {
                    const addIndividuals = Math.floor(leftover / indivPrice);
                    individuals += addIndividuals;
                    leftover -= addIndividuals * indivPrice;
                }
                const payId = 'pay_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
                const li = document.createElement("li");
                li.dataset.payid = payId;
                let payText = `${percent}% = `;
                if (stacks > 0) payText += `${stacks} stack(s) √ó ${item.bundleSize} ${item.name} (${stackPrice.toFixed(2)} BT stack)`;
                if (individuals > 0) {
                    if (stacks > 0) payText += " + ";
                    payText += `${individuals} √ó ${item.name} (${indivPrice.toFixed(2)} BT each)`;
                }
                const totalBT = stacks * stackPrice + individuals * indivPrice;
                payText += ` (${totalBT.toFixed(2)} BT)`;
                if (curr && curr !== BASE_CURRENCY) payText += " " + formatValue(totalBT, curr, false);
                li.textContent = payText;
                const removeBtn = document.createElement("button");
                removeBtn.textContent = "‚ùå";
                removeBtn.onclick = () => {
                    sellCart = sellCart.filter(it => !(it.isPayWith && it._payId === payId));
                    li.remove(); renderSellList(); calculateNet();
                };
                li.appendChild(removeBtn);
                payListEl.appendChild(li);
                if (stacks > 0) sellCart.push({ name: item.name, qty: stacks, price: stackPrice, bundleSize: item.bundleSize, isPayWith: true, _payId: payId });
                if (individuals > 0) sellCart.push({ name: item.name, qty: individuals, price: indivPrice, isPayWith: true, _payId: payId });
            });
            if (usedPercent !== 100) {
                document.getElementById("paymentResult").textContent =
                    `‚ö†Ô∏è Warning: payment percentages total ${usedPercent}%, not 100%.`;
            } else {
                document.getElementById("paymentResult").textContent =
                    `To pay ${owed.toFixed(2)} BT, bring the items listed above.`;
            }
            renderSellList(); calculateNet();
        }

        /* Converter (improved dynamic searchable inputs) */
        function addConverterRow() {
            const div = document.createElement("div");
            div.className = "payRow";

            const unique = 'convSelect_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
            const input = document.createElement("input");
            input.id = unique;
            input.className = 'dropdown-input';
            input.placeholder = 'Item name';

            const list = document.createElement("div");
            list.id = unique + 'List';
            list.className = 'dropdown-list';
            list.style.display = 'none';

            const wrap = document.createElement('div');
            wrap.className = 'dropdown-wrap';
            wrap.style.position = 'relative';
            wrap.appendChild(input);
            wrap.appendChild(list);

            const percent = document.createElement("input");
            percent.type = "number"; percent.value = 0; percent.min = 0; percent.max = 100; percent.placeholder = "%";

            const removeRowBtn = document.createElement("button");
            removeRowBtn.type = "button"; removeRowBtn.textContent = "‚ùå";
            removeRowBtn.onclick = () => { div.remove(); calculateConversion(); };

            div.appendChild(wrap);
            div.appendChild(document.createTextNode(" % of Net Balance: "));
            div.appendChild(percent);
            div.appendChild(removeRowBtn);
            document.getElementById("converterOptions").appendChild(div);

            attachDropdown(input.id, list.id, (q) => {
                const ql = (q || "").toLowerCase();
                if (!ql) return dropdownData.slice(0, 200);
                return dropdownData.filter(d => d.name.toLowerCase().includes(ql));
            }, (val) => { /* no-op */ });
        }
        function calculateConversion() {
            const converterList = document.getElementById("converterListDisplay");
            converterList.innerHTML = '';
            const netBT = parseFloat(document.getElementById("netTotal").dataset.raw) || 0;
            if (netBT <= 0) {
                document.getElementById("converterResult").textContent = '‚ö†Ô∏è Net Balance is not positive.';
                return;
            }
            buyCart = buyCart.filter(e => !e.isConverter);
            const rows = document.querySelectorAll("#converterOptions .payRow");
            let usedPercent = 0;
            rows.forEach(row => {
                const inputEl = row.querySelector('input.dropdown-input');
                const name = inputEl?.value.trim() || '';
                const percent = parseFloat(row.querySelector('input[type="number"]').value) || 0;
                const item = items.find(i => i.name === name);
                if (!item || percent <= 0) return;
                usedPercent += percent;
                const portion = (percent / 100) * netBT;
                let stackPrice = item.sellStack || (item.sellEach && item.bundleSize ? item.sellEach * item.bundleSize : 0);
                let indivPrice = item.sellEach || (item.sellStack && item.bundleSize ? item.sellStack / item.bundleSize : 0);
                if (!stackPrice && !indivPrice) return;
                let stacks = 0, individuals = 0, leftover = portion;
                if (stackPrice > 0) { stacks = Math.floor(portion / stackPrice); leftover -= stacks * stackPrice; }
                if (indivPrice > 0) {
                    const addIndividuals = Math.floor(leftover / indivPrice);
                    individuals += addIndividuals;
                    leftover -= addIndividuals * indivPrice;
                }
                const rowId = 'conv_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
                if (stacks > 0) buyCart.push({ name: item.name, qty: stacks, price: stackPrice, bundleSize: item.bundleSize, isConverter: true, _rowId: rowId });
                if (individuals > 0) buyCart.push({ name: item.name, qty: individuals, price: indivPrice, isConverter: true, _rowId: rowId });
                const li = document.createElement('li');
                let txt = `${percent}% = `;
                if (stacks > 0) txt += `${stacks} stack(s) √ó ${item.bundleSize} ${item.name} (${stackPrice.toFixed(2)} BT stack)`;
                if (individuals > 0) {
                    if (stacks > 0) txt += ' + ';
                    txt += `${individuals} √ó ${item.name} (${indivPrice.toFixed(2)} BT each)`;
                }
                const totalBT = stacks * stackPrice + individuals * indivPrice;
                txt += ` (${totalBT.toFixed(2)} BT)`;
                const curr = document.getElementById("currencySelect").value;
                if (curr && curr !== BASE_CURRENCY) txt += " " + formatValue(totalBT, curr, true);
                li.textContent = txt;
                const removeBtn = document.createElement('button');
                removeBtn.textContent = '‚ùå';
                removeBtn.onclick = () => {
                    buyCart = buyCart.filter(e => !(e.isConverter && e._rowId === rowId));
                    li.remove(); renderBuyList(); calculateNet();
                };
                li.appendChild(removeBtn);
                converterList.appendChild(li);
            });
            renderBuyList();
            if (usedPercent === 0) {
                document.getElementById("converterResult").textContent = '‚ö†Ô∏è No allocations set.';
            } else {
                document.getElementById("converterResult").textContent = `‚úÖ Conversion done. Allocated ${usedPercent}% of Net Balance.`;
            }
        }

        /* ===== Quick calculators ===== */
        function quickStackCalc() {
            const name = document.getElementById("quickStackSelect").value;
            const qty = parseInt(document.getElementById("quickStackQty").value) || 0;
            const item = items.find(i => i.name === name);
            if (!item) return;
            const buyText = item.buyStack ? `${qty} √ó ${item.bundleSize} ${item.name} buys for ${(qty * item.buyStack).toFixed(2)} BT` : "";
            const sellText = item.sellStack ? `${qty} √ó ${item.bundleSize} ${item.name} sells for ${(qty * item.sellStack).toFixed(2)} BT` : "";
            document.getElementById("quickStackResult").textContent = [buyText, sellText].filter(Boolean).join(" | ");
        }
        function quickIndivCalc() {
            const name = document.getElementById("quickIndivSelect").value;
            const qty = parseInt(document.getElementById("quickIndivQty").value) || 0;
            const item = items.find(i => i.name === name);
            if (!item) return;
            const buyText = item.buyEach ? `${qty} √ó ${item.name} buys for ${(qty * item.buyEach).toFixed(2)} BT` : "";
            const sellText = item.sellEach ? `${qty} √ó ${item.name} sells for ${(qty * item.sellEach).toFixed(2)} BT` : "";
            document.getElementById("quickIndivResult").textContent = [buyText, sellText].filter(Boolean).join(" | ");
        }

        /* ===== Add core store items (existing logic kept) ===== */
        function addStack() {
            const name = document.getElementById("stackSelect").value;
            const qty = parseInt(document.getElementById("stackQty").value) || 0;
            const item = items.find(i => i.name === name);
            if (!item || !item.sellStack) return;
            buyCart.push({ name: item.name, qty, price: item.sellStack, bundleSize: item.bundleSize, source: 'STORE' });
            renderBuyList();
        }
        function addIndividual() {
            const name = document.getElementById("indivSelect").value;
            const qty = parseInt(document.getElementById("indivQty").value) || 0;
            const item = items.find(i => i.name === name);
            if (!item || !item.sellEach) return;
            buyCart.push({ name: item.name, qty, price: item.sellEach, source: 'STORE' });
            renderBuyList();
        }
        function addBuyAccountBalance() {
            const balance = parseFloat(document.getElementById("buyAccountBalanceInput").value) || 0;
            if (balance <= 0) return;
            buyCart.push({ name: "Account Balance", qty: 1, price: balance, isBalance: true, source: 'BALANCE' });
            renderBuyList();
        }
        function addCustomBuyStack() {
            const name = document.getElementById("customBuyStackSelect").value;
            const qty = parseInt(document.getElementById("customBuyStackQty").value) || 0;
            const price = parseFloat(document.getElementById("customBuyStackPrice").value) || 0;
            const item = items.find(i => i.name === name);
            if (!item || qty <= 0 || price <= 0) return;
            buyCart.push({ name: item.name, qty, price, bundleSize: item.bundleSize, isCustom: true, source: 'STORE' });
            renderBuyList();
        }
        function addCustomBuyIndividual() {
            const name = document.getElementById("customBuyIndivSelect").value;
            const qty = parseInt(document.getElementById("customBuyIndivQty").value) || 0;
            const price = parseFloat(document.getElementById("customBuyIndivPrice").value) || 0;
            const item = items.find(i => i.name === name);
            if (!item || qty <= 0 || price <= 0) return;
            buyCart.push({ name: item.name, qty, price, isCustom: true, source: 'STORE' });
            renderBuyList();
        }
        function addFullyCustomBuy() {
            const name = document.getElementById("customBuyName").value.trim();
            const qty = parseInt(document.getElementById("customBuyQty").value) || 0;
            const stackSize = parseInt(document.getElementById("customBuyStackSize").value) || 1;
            const price = parseFloat(document.getElementById("customBuyPrice").value) || 0;
            if (!name || qty <= 0 || price <= 0 || stackSize <= 0) return;
            buyCart.push({ name, qty, bundleSize: stackSize, price, isFullyCustom: true, source: 'CUSTOM' });
            renderBuyList();
        }

        /* Sell side core additions */
        function addSellStack() {
            const name = document.getElementById("sellStackSelect").value;
            const qty = parseInt(document.getElementById("sellStackQty").value) || 0;
            const item = items.find(i => i.name === name);
            if (!item || !item.buyStack) return;
            sellCart.push({ name: item.name, qty, price: item.buyStack, bundleSize: item.bundleSize, source: 'STORE' });
            renderSellList();
        }
        function addSellIndividual() {
            const name = document.getElementById("sellIndivSelect").value;
            const qty = parseInt(document.getElementById("sellIndivQty").value) || 0;
            const item = items.find(i => i.name === name);
            if (!item || !item.buyEach) return;
            sellCart.push({ name: item.name, qty, price: item.buyEach, source: 'STORE' });
            renderSellList();
        }
        function addAccountBalance() {
            const balance = parseFloat(document.getElementById("accountBalanceInput").value) || 0;
            if (balance <= 0) return;
            sellCart.push({ name: "Account Balance", qty: 1, price: balance, isBalance: true, source: 'BALANCE' });
            renderSellList();
        }
        function addCustomSellStack() {
            const name = document.getElementById("customSellStackSelect").value;
            const qty = parseInt(document.getElementById("customSellStackQty").value) || 0;
            const price = parseFloat(document.getElementById("customSellStackPrice").value) || 0;
            const item = items.find(i => i.name === name);
            if (!item || qty <= 0 || price <= 0) return;
            sellCart.push({ name: item.name, qty, price, bundleSize: item.bundleSize, isCustom: true, source: 'STORE' });
            renderSellList();
        }
        function addCustomSellIndividual() {
            const name = document.getElementById("customSellIndivSelect").value;
            const qty = parseInt(document.getElementById("customSellIndivQty").value) || 0;
            const price = parseFloat(document.getElementById("customSellIndivPrice").value) || 0;
            const item = items.find(i => i.name === name);
            if (!item || qty <= 0 || price <= 0) return;
            sellCart.push({ name: item.name, qty, price, isCustom: true, source: 'STORE' });
            renderSellList();
        }
        function addFullyCustomSell() {
            const name = document.getElementById("customSellName").value.trim();
            const qty = parseInt(document.getElementById("customSellQty").value) || 0;
            const stackSize = parseInt(document.getElementById("customSellStackSize").value) || 1;
            const price = parseFloat(document.getElementById("customSellPrice").value) || 0;
            if (!name || qty <= 0 || price <= 0 || stackSize <= 0) return;
            sellCart.push({ name, qty, bundleSize: stackSize, price, isFullyCustom: true, source: 'CUSTOM' });
            renderSellList();
        }

        /* ===== Info boxes toggle ===== */
        function toggleInfo(id) {
            const el = document.getElementById(id);
            el.style.display = el.style.display === "block" ? "none" : "block";
        }

        /* ===== Placeholder handlers for future pages ===== */
        function openHistory() { alert('History page will be implemented separately.'); }
        function openOCM() { alert('OCM main page will be implemented separately.'); }

        /* ===== Init ===== */
        window.onload = () => {
            // loadData constructs stockProgressCache from the same sheet (D/J columns)
            loadData();
            addPayRow(); // initialize Pay With (search attaches when dropdownData gets populated)
        };
    </script>
</body>
</html>