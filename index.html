<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Vak Store Trading Calculator</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1100px;
            margin: auto;
        }

        h1, h2, h3 {
            color: #333;
        }

        .section {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            position: relative;
            background: #fff;
        }

        select, input[type="number"], input[list], input[type="text"], button {
            padding: 6px;
            margin: 6px 0;
        }

        ul {
            margin-top: 10px;
            padding-left: 18px;
        }

        .result {
            margin-top: 10px;
            font-weight: bold;
        }

        .payRow {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .payRow input[type="number"] {
                width: 60px;
            }

        .negative {
            color: red;
        }

        .positive {
            color: green;
        }

        .more-info-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.8em;
            padding: 4px 8px;
            cursor: pointer;
        }

        .info-box {
            display: none;
            background: #f9f9f9;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            border-radius: 6px;
        }

        li .remove {
            margin-left: 8px;
            color: red;
            cursor: pointer;
        }

        .section ul li a {
            color: #0066cc;
            text-decoration: none;
        }

            .section ul li a:hover {
                text-decoration: underline;
            }

        #topBar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 48px;
            background: #222;
            color: #fff;
            display: none;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            font-size: 14px;
        }

            #topBar a, #topBar button {
                color: #fff;
                text-decoration: none;
                margin-right: 18px;
                background: none;
                border: none;
                cursor: pointer;
            }

            #topBar .right {
                margin-left: auto;
                display: flex;
                gap: 12px;
            }

        body.withTopBar {
            padding-top: 70px;
        }

        .dropdown-wrap {
            position: relative;
            display: inline-block.
        }

        .dropdown-input {
            width: 250px;
            padding: 6px;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ccc;
            max-height: 220px;
            overflow-y: auto;
            z-index: 500;
            border-radius: 4px;
        }

        .dropdown-item {
            padding: 6px 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

            .dropdown-item:hover {
                background: #f0f6ff;
            }

            .dropdown-item.active {
                background: #dff0ff;
            }

        .stock-circle {
            width: 28px;
            height: 28px;
            flex: 0 0 auto;
        }

        .row-warning-yellow {
            background: #fff8d0;
        }

        .row-warning-red {
            background: #ffd6d6;
        }

        .small-note {
            font-size: 11px;
            color: #a00;
            margin-left: 8px;
        }

        .ocm-box {
            border: 1px dashed #999;
            padding: 10px;
            margin-top: 10px;
            border-radius: 6px;
            background: #fcfcfc;
        }

        .ocm-listing {
            font-size: 13px;
            margin: 2px 0;
        }

        .highlight-action {
            background: #e9f7ff;
        }

        .copy-btn {
            font-size: 12px;
            padding: 4px 6px;
        }

        #authPanel {
            margin-bottom: 20px;
        }

        #setupForm {
            display: none;
            margin-top: 10px;
        }

        #requestControls {
            margin-top: 20px;
        }

        @media (max-width:700px) {
            .dropdown-input {
                width: 180px;
            }
        }

        .login-hint {
            font-size: 12px;
            color: #555;
            margin-top: 4px;
        }

        .fallback-login {
            margin-top: 8px;
        }
    </style>
    <script src="app-config.js"></script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
    <div id="topBar">
        <div><strong>Vak Store</strong></div>
        <a id="historyLink" href="#" onclick="openHistory()">Account History</a>
        <a id="ocmHomeLink" href="#" onclick="openOCM()">OCM</a>
        <div class="right">
            <button onclick="logout()">Logout</button>
        </div>
    </div>

    <div id="authPanel">
        <div id="googleLoginArea">
            <div id="googleBtn"></div>
            <div class="login-hint">
                If the Google button does not appear or fails (FedCM / third‚Äëparty blocked), use fallback:
            </div>
            <div class="fallback-login">
                <button id="fallbackBtn" type="button" onclick="startFallbackLogin()">Fallback Google Login</button>
            </div>
            <div id="loginStatus"></div>
        </div>

        <!-- reCAPTCHA v2 visible checkbox container -->
        <div id="recaptchaContainer" style="margin-top:10px;"></div>

        <div id="setupForm">
            <h3>Account Setup</h3>
            <label>Player Name: <input type="text" id="setupPlayerName"></label><br>
            <label>Mailbox (e.g. 1A / 2B / F1): <input type="text" id="setupMailbox" placeholder="Format: RowSegment / DepthSegment / FloorSegment"></label><br>
            <button onclick="submitSetup()">Save Setup</button>
            <div id="setupMsg"></div>
        </div>
    </div>

    <h1>üõí Vak Store Trading Calculator</h1>

    <!-- Display Currency -->
    <div class="section">
        <label for="currencyInput"><b>Display Currency:</b></label>
        <input id="currencyInput" list="currencyDatalist" placeholder="Search currency / item">
        <input id="currencySelect" type="hidden" value="BT">
        <datalist id="currencyDatalist"></datalist>
    </div>

    <!-- Quick calculators -->
    <div class="section">
        <h2>üîπ Quick Individual Item Calculator</h2>
        <button class="more-info-btn" onclick="toggleInfo('quickInfo')">More Info</button>
        <div id="quickInfo" class="info-box">
            <p>Quick calc for a stack or individual item. Pick item and qty to see buy & sell totals.</p>
            <button onclick="toggleInfo('quickInfo')">‚ùå Close</button>
        </div>
        <div>
            <label>Select Full Stack Item:</label>
            <div class="dropdown-wrap">
                <input id="quickStackSelect" class="dropdown-input" placeholder="Type to search stack item">
                <div id="quickStackSelectList" class="dropdown-list" style="display:none;"></div>
            </div>
            <input type="number" id="quickStackQty" value="1" min="1">
            <button onclick="quickStackCalc()">Calculate Stack</button>
            <div id="quickStackResult" class="result"></div>
        </div>
        <div>
            <label>Select Individual Item:</label>
            <div class="dropdown-wrap">
                <input id="quickIndivSelect" class="dropdown-input" placeholder="Type to search indiv item">
                <div id="quickIndivSelectList" class="dropdown-list" style="display:none;"></div>
            </div>
            <input type="number" id="quickIndivQty" value="1" min="1">
            <button onclick="quickIndivCalc()">Calculate Individual</button>
            <div id="quickIndivResult" class="result"></div>
        </div>
    </div>

    <!-- Buy Multiple Items -->
    <div class="section" id="buySection">
        <h2>üîπ Buy Multiple Items</h2>
        <button class="more-info-btn" onclick="toggleInfo('buyInfo')">More Info</button>
        <div id="buyInfo" class="info-box">
            <p>Add stacks/individuals you want to buy. Includes OCM listings if desired.</p>
            <button onclick="toggleInfo('buyInfo')">‚ùå Close</button>
        </div>
        <h3>Full Stacks (Store)</h3>
        <div class="dropdown-wrap">
            <input id="stackSelect" class="dropdown-input" placeholder="Search stack item">
            <div id="stackSelectList" class="dropdown-list" style="display:none;"></div>
        </div>
        <input type="number" id="stackQty" value="1" min="1">
        <button onclick="addStack()">Add Stack</button>

        <h3>Individual Items (Store)</h3>
        <div class="dropdown-wrap">
            <input id="indivSelect" class="dropdown-input" placeholder="Search individual item">
            <div id="indivSelectList" class="dropdown-list" style="display:none;"></div>
        </div>
        <input type="number" id="indivQty" value="1" min="1">
        <button onclick="addIndividual()">Add Individual</button>

        <div class="ocm-box">
            <h3>OCM Listings (Buy)</h3>
            <input type="text" id="ocmBuyQuery" placeholder="Search OCM items">
            <button onclick="refreshOCMBuy()">Search</button>
            <div id="ocmBuyListings"></div>
            <label>Quantity: <input type="number" id="ocmBuyQty" value="1" min="1"></label>
            <button onclick="addOCMBuy()">Add OCM Item</button>
        </div>

        <h3>Account Balance</h3>
        <label>Enter Balance (BT): <input type="number" id="buyAccountBalanceInput" value="0"></label>
        <button onclick="addBuyAccountBalance()">‚ûï Add Balance</button>

        <h3>Custom Inputs (Store)</h3>
        <div>
            <strong>From Spreadsheet ‚Äî Stack</strong><br>
            <div class="dropdown-wrap">
                <input id="customBuyStackSelect" class="dropdown-input" placeholder="Item name">
                <div id="customBuyStackSelectList" class="dropdown-list" style="display:none;"></div>
            </div>
            <input type="number" id="customBuyStackQty" placeholder="Quantity" min="1">
            <input type="number" id="customBuyStackPrice" placeholder="Price per Stack" step="0.01">
            <button onclick="addCustomBuyStack()">Add Custom Stack</button>
        </div>
        <div>
            <strong>From Spreadsheet ‚Äî Individual</strong><br>
            <div class="dropdown-wrap">
                <input id="customBuyIndivSelect" class="dropdown-input" placeholder="Item name">
                <div id="customBuyIndivSelectList" class="dropdown-list" style="display:none;"></div>
            </div>
            <input type="number" id="customBuyIndivQty" placeholder="Quantity" min="1">
            <input type="number" id="customBuyIndivPrice" placeholder="Price per Each" step="0.01">
            <button onclick="addCustomBuyIndividual()">Add Custom Individual</button>
        </div>
        <div>
            <strong>Fully Custom</strong><br>
            <input type="text" id="customBuyName" placeholder="Name">
            <input type="number" id="customBuyQty" placeholder="Quantity (pieces)" min="1">
            <input type="number" id="customBuyStackSize" placeholder="Stack size" min="1">
            <input type="number" id="customBuyPrice" placeholder="Price per Stack" step="0.01">
            <button onclick="addFullyCustomBuy()">Add Fully Custom</button>
        </div>
        <ul id="buyList"></ul>
        <div id="buyTotalBox" class="negative">Buy Total: <span id="buyTotal">0.00</span></div>
    </div>

    <!-- Sell Multiple Items -->
    <div class="section" id="sellSection">
        <h2>üîπ Sell Multiple Items</h2>
        <button class="more-info-btn" onclick="toggleInfo('sellInfo')">More Info</button>
        <div id="sellInfo" class="info-box">
            <p>Add items you sell. Includes OCM interaction and Pay With.</p>
            <button onclick="toggleInfo('sellInfo')">‚ùå Close</button>
        </div>
        <h3>Full Stacks (Store)</h3>
        <div class="dropdown-wrap">
            <input id="sellStackSelect" class="dropdown-input" placeholder="Search stack item">
            <div id="sellStackSelectList" class="dropdown-list" style="display:none;"></div>
        </div>
        <input type="number" id="sellStackQty" value="1" min="1">
        <button onclick="addSellStack()">Add Stack</button>

        <h3>Individual Items (Store)</h3>
        <div class="dropdown-wrap">
            <input id="sellIndivSelect" class="dropdown-input" placeholder="Search individual item">
            <div id="sellIndivSelectList" class="dropdown-list" style="display:none;"></div>
        </div>
        <input type="number" id="sellIndivQty" value="1" min="1">
        <button onclick="addSellIndividual()">Add Individual</button>

        <div class="ocm-box">
            <h3>OCM Listings (Sell)</h3>
            <input type="text" id="ocmSellQuery" placeholder="Search OCM items">
            <button onclick="refreshOCMSell()">Search</button>
            <div id="ocmSellListings"></div>
            <label>Quantity: <input type="number" id="ocmSellQty" value="1" min="1"></label>
            <button onclick="addOCMSell()">Add OCM Item</button>
        </div>

        <h3>Account Balance</h3>
        <label>Enter Balance (BT): <input type="number" id="accountBalanceInput" value="0"></label>
        <button onclick="addAccountBalance()">‚ûï Add Balance</button>

        <h3>Custom Inputs (Store)</h3>
        <div>
            <strong>From Spreadsheet ‚Äî Stack</strong><br>
            <div class="dropdown-wrap">
                <input id="customSellStackSelect" class="dropdown-input" placeholder="Item name">
                <div id="customSellStackSelectList" class="dropdown-list" style="display:none;"></div>
            </div>
            <input type="number" id="customSellStackQty" placeholder="Quantity" min="1">
            <input type="number" id="customSellStackPrice" placeholder="Price per Stack" step="0.01">
            <button onclick="addCustomSellStack()">Add Custom Stack</button>
        </div>
        <div>
            <strong>From Spreadsheet ‚Äî Individual</strong><br>
            <div class="dropdown-wrap">
                <input id="customSellIndivSelect" class="dropdown-input" placeholder="Item name">
                <div id="customSellIndivSelectList" class="dropdown-list" style="display:none;"></div>
            </div>
            <input type="number" id="customSellIndivQty" placeholder="Quantity" min="1">
            <input type="number" id="customSellIndivPrice" placeholder="Price per Each" step="0.01">
            <button onclick="addCustomSellIndividual()">Add Custom Individual</button>
        </div>
        <div>
            <strong>Fully Custom</strong><br>
            <input type="text" id="customSellName" placeholder="Name">
            <input type="number" id="customSellQty" placeholder="Quantity (pieces)" min="1">
            <input type="number" id="customSellStackSize" placeholder="Stack size" min="1">
            <input type="number" id="customSellPrice" placeholder="Price per Stack" step="0.01">
            <button onclick="addFullyCustomSell()">Add Fully Custom</button>
        </div>
        <ul id="sellList"></ul>
        <div id="sellTotalBox" class="positive">Sell Total: <span id="sellTotal">0.00</span></div>
    </div>

    <!-- Combined Totals -->
    <div class="section">
        <h2>üîπ Combined Totals</h2>
        <button class="more-info-btn" onclick="toggleInfo('combinedInfo')">More Info</button>
        <div id="combinedInfo" class="info-box">
            <p>Net Balance: sell - buy.</p>
            <button onclick="toggleInfo('combinedInfo')">‚ùå Close</button>
        </div>
        <div id="combinedTotalBox">Net Balance: <span id="netTotal">0.00</span></div>
    </div>

    <!-- Pay With -->
    <div class="section">
        <h2>üîπ Pay With</h2>
        <button class="more-info-btn" onclick="toggleInfo('payInfo')">More Info</button>
        <div id="payInfo" class="info-box">
            <p>Cover a negative net with item payments.</p>
            <button onclick="toggleInfo('payInfo')">‚ùå Close</button>
        </div>
        <div id="payOptions"></div>
        <button onclick="addPayRow()">‚ûï Add Item</button>
        <ul id="payList"></ul>
        <button onclick="calculatePayment()">Calculate Payment</button>
        <div id="paymentResult" class="result"></div>
    </div>

    <!-- Item Converter -->
    <div class="section">
        <h2>üîπ Item Converter</h2>
        <button class="more-info-btn" onclick="toggleInfo('converterInfo')">More Info</button>
        <div id="converterInfo" class="info-box">
            <p>Allocate % of positive Net Balance into items.</p>
            <button onclick="toggleInfo('converterInfo')">‚ùå Close</button>
        </div>
        <div id="converterOptions"></div>
        <button onclick="addConverterRow()">‚ûï Add Item</button>
        <ul id="converterListDisplay"></ul>
        <button onclick="calculateConversion()">Convert Balance</button>
        <div id="converterResult" class="result"></div>
    </div>

    <!-- Request Controls -->
    <div id="requestControls" class="section" style="display:none;">
        <h2>üîπ Transaction Request</h2>
        <button onclick="submitPurchaseRequest()">Submit Purchase Request</button>
        <button class="copy-btn" onclick="copyTransactionData()">Copy Transaction Data</button>
        <div id="requestMsg"></div>
    </div>

    <!-- Links -->
    <div class="section">
        <h2>üîó Useful Links</h2>
        <ul>
            <li><a href="https://translocator.moe/" target="_blank">TL route calculator</a></li>
            <li><a href="https://map.tops.vintagestory.at/?x=-419&y=416&zoom=6" target="_blank">TOPS map</a></li>
            <li><a href="https://wiki.vintagestory.at/Main_Page" target="_blank">Wiki</a></li>
            <li><a href="https://docs.google.com/spreadsheets/d/1W9ByTiwX3lPakqoYXTHgnOiMNNzwSVnkgmTPqvMrSUc/edit?gid=0#gid=0" target="_blank">Mailbox names</a></li>
            <li><a href="https://docs.google.com/spreadsheets/d/1_meliJtuKSDwEWRDh1gldcsD-pSjDgIND3dcE1mCjCo/edit?gid=0#gid=0" target="_blank">PRICE SHEET</a></li>
            <li><a href="https://www.vintagestory.at/" target="_blank">Vintage Story official website</a></li>
            <li><a href="https://mods.vintagestory.at/" target="_blank">Official mods page</a></li>
            <li><a href="BTIncurance.html" target="_blank">BT Insurance</a></li>
            <li><a href="PriceHistory.html" target="_blank">Price History</a></li>
            <li><a href="VintageStoryEconomics.html" target="_blank">Vintage Story Economics</a></li>
        </ul>
    </div>

    <script>
        // Replace the three const lines with this block (just once)
        const WEB_APP_URL = window.WEB_APP_URL || 'https://yellow-king-52c6.vilhokettu1.workers.dev/exec';
        const RECAPTCHA_SITE_KEY = window.RECAPTCHA_SITE_KEY || '6LdjcAgsAAAAABWoHl5dmFjbJQL61kOu7ddvkUZF';
        const OAUTH_CLIENT_ID = window.OAUTH_CLIENT_ID || '857098772457-kuvq861sa844esf2jc4b7av1pnlmnn1c.apps.googleusercontent.com';
    </script>

    <script>
        /* ===== CONFIG ===== */
        // IMPORTANT: Apps Script blocks cross-origin POSTs due to CORS.
        // To avoid "Failed to fetch" on POST, point this to an HTTPS proxy you control (see instructions below).
        // Example for direct Apps Script (GETs OK, POSTs blocked by CORS):
        

        const sheetURL = "https://docs.google.com/spreadsheets/d/1_meliJtuKSDwEWRDh1gldcsD-pSjDgIND3dcE1mCjCo/gviz/tq?tqx=out:json&gid=0";

        let items = [], payItems = [], buyCart = [], sellCart = [];
        let stockProgressCache = []; // {name, currentStacks, targetStacks}
        let currentUser = null;
        let googleIdToken = null;
        const BASE_CURRENCY = "BT";
        let dropdownData = [];

        // reCAPTCHA v2
        let recaptchaWidgetId = null;
        let lastRecaptchaToken = null;

        /* ===== Google Login (GSI primary + fallback) ===== */
        function initGoogleIdentity() {
            if (!window.google || !google.accounts || !google.accounts.id) {
                console.warn('GSI script not loaded yet');
                return;
            }
            google.accounts.id.initialize({
                client_id: OAUTH_CLIENT_ID,
                callback: handleCredentialResponse,
                ux_mode: 'popup',
                auto_select: false,
                use_fedcm_for_prompt: false
            });
            google.accounts.id.renderButton(
                document.getElementById('googleBtn'),
                { theme: 'outline', size: 'large', type: 'standard', shape: 'rectangular', logo_alignment: 'left' }
            );
        }

        function handleCredentialResponse(resp) {
            onGoogleSignIn(resp);
        }

        function startFallbackLogin() {
            const nonce = cryptoRandomId();
            const redirectUri = location.origin + location.pathname; // same page
            const authUrl =
                'https://accounts.google.com/o/oauth2/v2/auth' +
                '?client_id=' + encodeURIComponent(OAUTH_CLIENT_ID) +
                '&redirect_uri=' + encodeURIComponent(redirectUri) +
                '&response_type=id_token' +
                '&scope=' + encodeURIComponent('openid email profile') +
                '&nonce=' + encodeURIComponent(nonce) +
                '&prompt=select_account';
            window.location.href = authUrl;
        }

        function checkHashForIdToken() {
            if (location.hash) {
                const params = new URLSearchParams(location.hash.slice(1));
                const idt = params.get('id_token');
                if (idt) {
                    handleCredentialResponse({ credential: idt });
                    history.replaceState({}, document.title, location.pathname + location.search);
                }
            }
        }
        // --- insert near top of your script, after variable declarations ---
        function normalizeUser(u) {
            if (!u) return u;
            // Accept common alternate keys and trim whitespace
            const candidate =
                (u.playerName && String(u.playerName).trim()) ||
                (u.player && String(u.player).trim()) ||
                (u.name && String(u.name).trim()) ||
                (u.displayName && String(u.displayName).trim()) ||
                null;
            // Ensure playerName property exists when possible
            u.playerName = candidate || null;
            return u;
        }
        /* ===== Google Sign-in callback ===== */

        // === REPLACE EXISTING onGoogleSignIn WITH THIS ===
        async function onGoogleSignIn(resp) {
            googleIdToken = resp && resp.credential;
            const statusEl = document.getElementById('loginStatus');
            if (!googleIdToken) {
                statusEl.textContent = 'Login error: no credential';
                console.error('onGoogleSignIn: no credential', resp);
                return;
            }
            statusEl.textContent = 'Verifying token...';
            try {
                const tResp = await fetch(`https://oauth2.googleapis.com/tokeninfo?id_token=${encodeURIComponent(googleIdToken)}`);
                if (!tResp.ok) throw new Error('tokeninfo failed ' + tResp.status);
                const info = await tResp.json();
                if (info.aud !== OAUTH_CLIENT_ID) throw new Error('Invalid audience');
                window.googleTokenInfo = info;

                // Fetch server user
                statusEl.textContent = 'Loading profile...';
                const meResp = await fetch(`${WEB_APP_URL}?action=me&idToken=${encodeURIComponent(googleIdToken)}`);
                const meJson = await meResp.json();
                console.log('onGoogleSignIn /me', meJson);

                if (!meJson.ok) throw new Error(meJson.error || 'Backend error');

                const serverUser = normalizeUser(meJson.data.user || null);
                currentUser = serverUser;

                const hasSetup = serverUser && serverUser.playerName;
                const passedCaptcha = serverUser && serverUser.captchaPassed;

                if (hasSetup && passedCaptcha) {
                    // Solid completed setup
                    localStorage.setItem('vak_captcha_ok', '1');
                    hideRecaptchaWidget();
                    hideSetupShowApp();
                } else {
                    // Incomplete ‚Äì reset local flag & show captcha
                    localStorage.removeItem('vak_captcha_ok');
                    showSetupOnly();
                    showRecaptchaWidget();
                }

                showTopBar();
                statusEl.textContent = 'Logged in.';
            } catch (e) {
                statusEl.textContent = 'Login error: ' + e.message;
                console.error('onGoogleSignIn error:', e);
            }
        }

        // Helper to show captcha container
        function showRecaptchaWidget() {
            const c = document.getElementById('recaptchaContainer');
            if (c) c.style.display = 'block';
        }
        function hideRecaptchaWidget() {
            const c = document.getElementById('recaptchaContainer');
            if (c) c.style.display = 'none';
        }

        // === ADD / REPLACE refreshUserStateAfterSetup ===
        async function refreshUserStateAfterSetup() {
            const meResp = await fetch(`${WEB_APP_URL}?action=me&idToken=${encodeURIComponent(googleIdToken)}`);
            const meJson = await meResp.json();
            console.log('refreshUserStateAfterSetup /me', meJson);
            if (!meJson.ok) throw new Error(meJson.error || 'me failed');
            const serverUser = normalizeUser(meJson.data.user || null);
            currentUser = serverUser;
            const hasSetup = serverUser && serverUser.playerName;
            const passedCaptcha = serverUser && serverUser.captchaPassed;
            return { hasSetup, passedCaptcha };
        }

        // === REPLACE EXISTING submitSetup WITH THIS ===
        async function submitSetup() {
            const playerName = document.getElementById('setupPlayerName').value.trim();
            const mailbox = document.getElementById('setupMailbox').value.trim();
            const statusEl = document.getElementById('setupMsg');

            if (!googleIdToken) { statusEl.textContent = 'Login first'; return; }
            if (!playerName || !mailbox) { statusEl.textContent = 'Player name and mailbox required'; return; }

            // Decide if we must still collect captcha (server did not confirm pass yet)
            const needCaptcha = !localStorage.getItem('vak_captcha_ok');
            let recaptchaToken = null;
            if (needCaptcha) {
                try {
                    recaptchaToken = await recaptchaWrap(); // will throw if not completed
                } catch (e) {
                    statusEl.textContent = e.message;
                    return;
                }
            }

            statusEl.textContent = 'Saving...';

            try {
                const body = {
                    action: 'linkPlayer',
                    idToken: googleIdToken,
                    payload: { playerName, mailbox }
                };
                if (recaptchaToken) body.recaptchaToken = recaptchaToken;

                const resp = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const j = await resp.json();
                console.log('submitSetup linkPlayer', j);
                if (!j.ok) throw new Error(j.error || 'linkPlayer failed');

                // Re-fetch user state to confirm persistence & captcha
                statusEl.textContent = 'Verifying saved data...';
                const { hasSetup, passedCaptcha } = await refreshUserStateAfterSetup();

                if (hasSetup && passedCaptcha) {
                    localStorage.setItem('vak_captcha_ok', '1');
                    hideRecaptchaWidget();
                    hideSetupShowApp();
                    showTopBar();
                    statusEl.textContent = 'Setup complete.';
                } else {
                    // Do NOT set local flag ‚Äì requires another captcha attempt
                    localStorage.removeItem('vak_captcha_ok');
                    showRecaptchaWidget();
                    statusEl.textContent = 'Server did not confirm setup yet. Retry (captcha still required).';
                }
            } catch (e) {
                statusEl.textContent = 'Error: ' + e.message;
                console.error('submitSetup error', e);
            }
        }

        // === REPLACE EXISTING recaptchaWrap WITH THIS ===
        function recaptchaWrap() {
            return new Promise((resolve, reject) => {
                // Only skip if local flag is set AND we already have a server-confirmed captchaPassed user
                const canSkip = localStorage.getItem('vak_captcha_ok') === '1' &&
                    currentUser && currentUser.playerName && currentUser.captchaPassed;
                if (canSkip) return resolve(null);

                if (lastRecaptchaToken) return resolve(lastRecaptchaToken);

                if (window.grecaptcha) {
                    document.getElementById('recaptchaContainer').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return reject(new Error('Complete reCAPTCHA checkbox first.'));
                }
                reject(new Error('reCAPTCHA not loaded yet.'));
            });
        }


        function logout() {
            googleIdToken = null;
            currentUser = null;
            document.getElementById('loginStatus').textContent = 'Logged out.';
            document.getElementById('topBar').style.display = 'none';
            document.body.classList.remove('withTopBar');
            document.getElementById('requestControls').style.display = 'none';
            // Keep local captcha flag so user isn't prompted again on next visit
        }

        async function submitSetup() {
            const playerName = document.getElementById('setupPlayerName').value.trim();
            const mailbox = document.getElementById('setupMailbox').value.trim();
            const statusEl = document.getElementById('setupMsg');

            if (!playerName || !mailbox) {
                statusEl.textContent = 'Player name and mailbox required';
                return;
            }

            // If previously passed captcha (client-side flag), skip asking again
            const skipCaptcha = localStorage.getItem('vak_captcha_ok') === '1';

            const doPost = (tokenOrNull) => {
                const body = {
                    action: 'linkPlayer',
                    idToken: googleIdToken,
                    payload: { playerName, mailbox }
                };
                if (tokenOrNull) body.recaptchaToken = tokenOrNull;
                return fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
            };

            statusEl.textContent = 'Saving...';

            try {
                const token = skipCaptcha ? null : await recaptchaWrap();
                const postResp = await doPost(token);
                const postJson = await postResp.json();
                console.log('submitSetup: linkPlayer response', postJson);
                if (!postJson.ok) throw new Error(postJson.error || 'linkPlayer failed');

                // Mark client flag so we no longer prompt for captcha
                localStorage.setItem('vak_captcha_ok', '1');
                const c = document.getElementById('recaptchaContainer'); if (c) c.style.display = 'none';
                statusEl.textContent = 'Setup saved. Verifying...';

                // Re-fetch user record from server
                const meResp = await fetch(`${WEB_APP_URL}?action=me&idToken=${encodeURIComponent(googleIdToken)}`);
                if (!meResp.ok) throw new Error('me fetch failed ' + meResp.status);
                const meJson = await meResp.json();
                console.log('submitSetup: /me response', meJson);
                if (!meJson.ok) throw new Error(meJson.error || 'me returned not ok');

                const serverUser = normalizeUser(meJson.data?.user || null);
                if (serverUser && serverUser.playerName) {
                    currentUser = Object.assign({}, currentUser || {}, serverUser);
                } else {
                    // Server did not return user data ‚Äî make optimistic local user using token info
                    const tokenInfo = window.googleTokenInfo || {};
                    currentUser = {
                        userId: tokenInfo.sub || (currentUser && currentUser.userId),
                        email: tokenInfo.email || (currentUser && currentUser.email),
                        playerName,
                        mailbox
                    };
                    console.warn('submitSetup: server did not return user; using optimistic local user', currentUser);
                    // still advise to check server logs; but enable UI so user can continue
                    statusEl.textContent = 'Setup saved locally; server did not return user. If this persists check server logs.';
                }

                enableAppUI();
                showTopBar();
                document.getElementById('setupForm').style.display = 'none';
                statusEl.textContent = 'Setup complete.';
            } catch (e) {
                console.error('submitSetup error:', e);
                statusEl.textContent = 'Error: ' + (e && e.message ? e.message : String(e));
            }
        }
        function showSetupOnly() {
            // Show the setup form, hide request controls and ensure reCAPTCHA is visible
            const setup = document.getElementById('setupForm');
            const req = document.getElementById('requestControls');
            if (setup) setup.style.display = 'block';
            if (req) req.style.display = 'none';
            // If you have a recaptcha helper, show it; otherwise un-hide container
            if (typeof showRecaptchaWidget === 'function') showRecaptchaWidget();
            else {
                const c = document.getElementById('recaptchaContainer'); if (c) c.style.display = 'block';
            }
        }

        function hideSetupShowApp() {
            // Hide the setup form and enable the app UI (request controls + top bar)
            const setup = document.getElementById('setupForm');
            if (setup) setup.style.display = 'none';
            if (typeof enableAppUI === 'function') enableAppUI();
            if (typeof hideRecaptchaWidget === 'function') hideRecaptchaWidget();
            else {
                const c = document.getElementById('recaptchaContainer'); if (c) c.style.display = 'none';
            }
            if (typeof showTopBar === 'function') showTopBar();
        }
        function enableAppUI() { document.getElementById('requestControls').style.display = 'block'; }
        function showTopBar() {
            if (googleIdToken && currentUser) {
                document.getElementById('topBar').style.display = 'flex';
                document.body.classList.add('withTopBar');
            }
        }

        /* ===== reCAPTCHA v2 (prompt only once) ===== */
        function initRecaptcha() {
            // If user already passed captcha (client-side flag), hide the widget and skip
            if (localStorage.getItem('vak_captcha_ok') === '1') {
                const c = document.getElementById('recaptchaContainer');
                if (c) c.style.display = 'none';
                lastRecaptchaToken = null;
                return;
            }
            const tryRender = () => {
                if (window.grecaptcha && recaptchaWidgetId === null) {
                    recaptchaWidgetId = grecaptcha.render('recaptchaContainer', {
                        sitekey: RECAPTCHA_SITE_KEY,
                        callback: t => { lastRecaptchaToken = t; },
                        'expired-callback': () => { lastRecaptchaToken = null; }
                    });
                }
            };
            if (window.grecaptcha) tryRender();
            else {
                let tries = 0;
                const iv = setInterval(() => {
                    tries++;
                    if (window.grecaptcha) { tryRender(); clearInterval(iv); }
                    if (tries > 20) clearInterval(iv);
                }, 250);
            }
        }

        function recaptchaWrap() {
            return new Promise((resolve, reject) => {
                // Skip if client-side flag is set (server will enforce its own "once" rule)
                if (localStorage.getItem('vak_captcha_ok') === '1') return resolve(null);
                if (lastRecaptchaToken) return resolve(lastRecaptchaToken);
                if (window.grecaptcha) {
                    document.getElementById('recaptchaContainer').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return reject(new Error('Complete reCAPTCHA checkbox first.'));
                }
                reject(new Error('reCAPTCHA not loaded.'));
            });
        }

        /* ===== Utility ===== */
        function cryptoRandomId() { return (crypto.getRandomValues(new Uint32Array(4))).join('-'); }

        /* ===== Custom dropdown / circular stock indicator implementation ===== */
        function computeEffectiveTargetStacks(item, prog) {
            if (!prog) return 0;
            const t = Number(prog.targetStacks || 0);
            return isFinite(t) && t > 0 ? t : 0;
        }

        function attachDropdown(inputId, listId, filterFn, selectCallback) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            if (!input || !list) return;
            function setActiveIndex(idx) {
                const itemsEls = Array.from(list.querySelectorAll('.dropdown-item'));
                itemsEls.forEach(it => it.classList.remove('active'));
                if (idx >= 0 && idx < itemsEls.length) {
                    itemsEls[idx].classList.add('active');
                    itemsEls[idx].scrollIntoView({ block: 'nearest' });
                    input._dropIndex = idx;
                } else input._dropIndex = -1;
            }
            function renderAndShow() {
                const q = (input.value || "").toLowerCase();
                const filtered = filterFn(q);
                renderDropdownList(list, filtered, (val) => {
                    input.value = val; list.style.display = 'none'; input._dropIndex = -1;
                    if (selectCallback) selectCallback(val);
                });
                input._dropIndex = -1;
                list.style.display = list.querySelectorAll('.dropdown-item').length ? 'block' : 'none';
            }
            input.addEventListener('input', renderAndShow);
            input.addEventListener('focus', renderAndShow);
            input.addEventListener('keydown', ev => {
                const itemsEls = Array.from(list.querySelectorAll('.dropdown-item'));
                if (!itemsEls.length) return;
                if (ev.key === 'ArrowDown') { ev.preventDefault(); setActiveIndex(Math.min((input._dropIndex || -1) + 1, itemsEls.length - 1)); }
                else if (ev.key === 'ArrowUp') { ev.preventDefault(); setActiveIndex(Math.max((input._dropIndex || -1) - 1, 0)); }
                else if (ev.key === 'Enter') {
                    if (typeof input._dropIndex === 'number' && input._dropIndex >= 0) { ev.preventDefault(); itemsEls[input._dropIndex].click(); }
                } else if (ev.key === 'Escape') { list.style.display = 'none'; input._dropIndex = -1; }
            });
            input.addEventListener('blur', () => setTimeout(() => { list.style.display = 'none'; input._dropIndex = -1; }, 200));
        }

        function renderDropdownList(container, arr, onSelect) {
            container.innerHTML = '';
            arr.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                div.dataset.index = String(idx);

                const itemObj = items.find(it => it.name === item.name);
                const prog = stockProgressCache.find(sp => sp.name === item.name);

                let pct = 0;
                if (prog) {
                    const target = computeEffectiveTargetStacks(itemObj, prog);
                    if (target > 0) pct = Math.round((Number(prog.currentStacks || 0) / target) * 100);
                }
                pct = Math.max(0, Math.min(100, pct));

                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                circle.setAttribute('class', 'stock-circle');
                circle.setAttribute('viewBox', '0 0 36 36');

                const bg = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                bg.setAttribute('cx', '18'); bg.setAttribute('cy', '18'); bg.setAttribute('r', '16');
                bg.setAttribute('stroke', '#eee'); bg.setAttribute('stroke-width', '4'); bg.setAttribute('fill', 'none');

                const fg = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                fg.setAttribute('cx', '18'); fg.setAttribute('cy', '18'); fg.setAttribute('r', '16');
                fg.setAttribute('stroke', pct >= 100 ? '#3cb371' : '#2196f3');
                fg.setAttribute('stroke-width', '4'); fg.setAttribute('fill', 'none');
                fg.setAttribute('stroke-dasharray', Math.round((pct / 100) * 2 * Math.PI * 16) + ',1000');
                fg.setAttribute('transform', 'rotate(-90 18 18)');

                circle.appendChild(bg);
                circle.appendChild(fg);

                const label = document.createElement('div');
                label.innerHTML = `<strong>${item.name}</strong><br><small>${item.extra}</small>`;

                div.appendChild(circle);
                div.appendChild(label);

                div.addEventListener('mouseover', () => {
                    Array.from(container.querySelectorAll('.dropdown-item')).forEach(s => s.classList.remove('active'));
                    div.classList.add('active');
                });
                div.onclick = () => onSelect(item.name);
                container.appendChild(div);
            });
        }

        /* ===== Data loading ===== */
        function loadData() {
            fetch(sheetURL)
                .then(r => { if (!r.ok) throw new Error(r.status); return r.text(); })
                .then(txt => {
                    let payloadText = txt;
                    const start = payloadText.indexOf('('), end = payloadText.lastIndexOf(')');
                    if (start > -1 && end > start) payloadText = payloadText.slice(start + 1, end);
                    const json = JSON.parse(payloadText);
                    const rows = json?.table?.rows || [];
                    items = rows.map(row => {
                        const c = row.c || [];
                        const name = c[0]?.v ?? "";
                        const buyStack = c[1]?.v ?? "";
                        const sellStack = c[2]?.v ?? "";
                        const stackStock = Number(c[3]?.v ?? 0);
                        const bundleSize = Number(c[4]?.v ?? 1);
                        const buyEach = c[5]?.v ?? "";
                        const sellEach = c[6]?.v ?? "";
                        const indivStock = Number(c[7]?.v ?? 0);
                        const availPercent = Number(c[8]?.v ?? 0);
                        const targetEach = Number(c[9]?.v ?? 0);
                        if (!name) return null;
                        if ((buyStack === "X" && sellStack === "X") && (buyEach === "X" && sellEach === "X")) return null;
                        const parseNumOrNull = v => {
                            if (v === null || v === "" || v === undefined) return null;
                            const n = Number(v); return isNaN(n) ? null : n;
                        };
                        return {
                            name: String(name),
                            bundleSize: bundleSize || 1,
                            stackStock, indivStock, availPercent, targetEach: targetEach || 0,
                            buyStack: parseNumOrNull(buyStack),
                            sellStack: parseNumOrNull(sellStack),
                            buyEach: parseNumOrNull(buyEach),
                            sellEach: parseNumOrNull(sellEach)
                        };
                    }).filter(Boolean);

                    stockProgressCache = items.map(i => {
                        const bundleSize = Number(i.bundleSize || 1) || 1;
                        const currentStacks = (Number(i.indivStock || 0) / bundleSize);
                        const targetStacks = Number(i.targetEach || 0);
                        return { name: i.name, currentStacks, targetStacks };
                    });

                    payItems = items.slice();
                    populateCurrencyDatalist();
                    setupDropdowns();
                })
                .catch(err => {
                    console.error('Failed to load sheet:', err);
                    items = []; payItems = []; stockProgressCache = [];
                    populateCurrencyDatalist(); setupDropdowns();
                });
        }

        function populateCurrencyDatalist() {
            const currencyDatalist = document.getElementById("currencyDatalist");
            currencyDatalist.innerHTML = "";
            currencyDatalist.appendChild(new Option(BASE_CURRENCY, BASE_CURRENCY));
            items.forEach(i => {
                currencyDatalist.appendChild(new Option(`${i.name} ‚Äî stack:${i.stackStock} each:${i.indivStock} avail:${i.availPercent}%`, i.name));
            });
            const input = document.getElementById("currencyInput");
            const hidden = document.getElementById("currencySelect");
            input.onchange = () => {
                const val = input.value.trim();
                const exact = items.find(it => it.name.toLowerCase() === val.toLowerCase());
                hidden.value = exact ? exact.name : BASE_CURRENCY;
                updateAllDisplays();
            };
            input.oninput = () => {
                const v = input.value.trim();
                const exact = items.find(it => it.name.toLowerCase() === v.toLowerCase());
                if (exact) { hidden.value = exact.name; updateAllDisplays(); }
            };
        }

        function setupDropdowns() {
            dropdownData = items.map(i => ({ name: i.name, extra: `stkStock:${i.stackStock} eachStock:${i.indivStock} avail:${i.availPercent}%` }));
            function filterBy(q) { if (!q) return dropdownData.slice(0, 200); return dropdownData.filter(d => d.name.toLowerCase().includes(q)); }
            attachDropdown('quickStackSelect', 'quickStackSelectList', filterBy, () => { });
            attachDropdown('quickIndivSelect', 'quickIndivSelectList', filterBy, () => { });
            attachDropdown('stackSelect', 'stackSelectList', filterBy, () => { });
            attachDropdown('indivSelect', 'indivSelectList', filterBy, () => { });
            attachDropdown('sellStackSelect', 'sellStackSelectList', filterBy, () => { });
            attachDropdown('sellIndivSelect', 'sellIndivSelectList', filterBy, () => { });
            attachDropdown('customBuyStackSelect', 'customBuyStackSelectList', filterBy, () => { });
            attachDropdown('customBuyIndivSelect', 'customBuyIndivSelectList', filterBy, () => { });
            attachDropdown('customSellStackSelect', 'customSellStackSelectList', filterBy, () => { });
            attachDropdown('customSellIndivSelect', 'customSellIndivSelectList', filterBy, () => { });
        }

        let ocmListingsCacheBuy = [], ocmListingsCacheSell = [];
        function refreshOCMBuy() {
            const q = document.getElementById('ocmBuyQuery').value.trim();
            fetch(`${WEB_APP_URL}?action=listings&q=${encodeURIComponent(q)}`)
                .then(r => r.json()).then(j => {
                    if (!j.ok) throw new Error(j.error);
                    ocmListingsCacheBuy = j.data.filter(l => l.type === 'SELL');
                    renderOCMListings('ocmBuyListings', ocmListingsCacheBuy);
                }).catch(e => { document.getElementById('ocmBuyListings').textContent = 'Error: ' + e.message; });
        }
        function refreshOCMSell() {
            const q = document.getElementById('ocmSellQuery').value.trim();
            fetch(`${WEB_APP_URL}?action=listings&q=${encodeURIComponent(q)}`)
                .then(r => r.json()).then(j => {
                    if (!j.ok) throw new Error(j.error);
                    ocmListingsCacheSell = j.data.filter(l => l.type === 'BUY');
                    renderOCMListings('ocmSellListings', ocmListingsCacheSell);
                }).catch(e => { document.getElementById('ocmSellListings').textContent = 'Error: ' + e.message; });
        }
        function renderOCMListings(containerId, arr) {
            const el = document.getElementById(containerId); el.innerHTML = '';
            if (!arr.length) { el.textContent = 'No listings'; return; }
            arr.forEach(l => {
                const div = document.createElement('div'); div.className = 'ocm-listing';
                div.textContent = `${l.itemName} | ${l.type} | ${l.unit} | price:${l.priceBT} | qty:${l.qtyAvailable || '‚àû'} | by ${l.playerName}`;
                div.dataset.listingId = l.listingId;
                div.onclick = () => {
                    Array.from(el.children).forEach(c => c.classList.remove('highlight-action'));
                    div.classList.add('highlight-action');
                    el.dataset.selectedListingId = l.listingId;
                };
                el.appendChild(div);
            });
        }
        function addOCMBuy() {
            const id = document.getElementById('ocmBuyListings').dataset.selectedListingId;
            if (!id) return alert('Select an OCM SELL listing first');
            const listing = ocmListingsCacheBuy.find(l => l.listingId === id);
            const qty = parseInt(document.getElementById('ocmBuyQty').value) || 0;
            if (!listing || qty <= 0) return;
            buyCart.push({ name: listing.itemName, qty, price: Number(listing.priceBT), source: 'OCM', listingId: id });
            renderBuyList();
        }
        function addOCMSell() {
            const id = document.getElementById('ocmSellListings').dataset.selectedListingId;
            if (!id) return alert('Select an OCM BUY listing first');
            const listing = ocmListingsCacheSell.find(l => l.listingId === id);
            const qty = parseInt(document.getElementById('ocmSellQty').value) || 0;
            if (!listing || qty <= 0) return;
            sellCart.push({ name: listing.itemName, qty, price: Number(listing.priceBT), source: 'OCM', listingId: id });
            renderSellList();
        }

        /* ===== Row coloring against stock & target ===== */
        function evaluateRowColorBuy(entry) {
            const item = items.find(i => i.name === entry.name);
            const prog = stockProgressCache.find(sp => sp.name === entry.name);
            if (!item && !prog) return null;
            if (entry.source === 'OCM') return null;

            const bundleSize = item ? (item.bundleSize || 1) : 1;
            const requestedStacks = entry.bundleSize ? Number(entry.qty || 0) : (Number(entry.qty || 0) / bundleSize);
            const availableStacks = (item ? (Number(item.stackStock || 0) + (Number(item.indivStock || 0) / bundleSize)) : (prog ? prog.currentStacks : 0));

            if (availableStacks <= 0) return 'row-warning-red';

            const ratio = requestedStacks / availableStacks;
            if (ratio > 1) return 'row-warning-red';
            if (ratio > 0.5) return 'row-warning-yellow';
            return null;
        }
        function evaluateRowColorSell(entry) {
            const prog = stockProgressCache.find(sp => sp.name === entry.name);
            const item = items.find(i => i.name === entry.name);
            if (!prog || entry.source === 'OCM') return null;
            const bundleSize = item ? (Number(item.bundleSize || 1) || 1) : 1;
            const sellingStacks = entry.bundleSize ? Number(entry.qty || 0) : (Number(entry.qty || 0) / bundleSize);
            const currentStacks = Number(prog.currentStacks || 0);
            const projected = currentStacks + sellingStacks;

            const effectiveTarget = computeEffectiveTargetStacks(item, prog);
            if (effectiveTarget > 0 && projected > effectiveTarget) return 'row-warning-red';
            return null;
        }

        function formatValue(btValue, currencyName, forBuy) {
            if (isNaN(btValue)) btValue = 0;
            let txt = `${btValue.toFixed(2)} ${BASE_CURRENCY}`;
            if (currencyName && currencyName !== BASE_CURRENCY) {
                const currency = items.find(i => i.name.toLowerCase() === currencyName.toLowerCase());
                if (currency) {
                    const rate = forBuy ? (currency.buyEach || currency.buyStack || 0) : (currency.sellEach || currency.sellStack || 0);
                    if (rate > 0) { txt += ` (‚âà ${(btValue / rate).toFixed(2)} ${currencyName})`; }
                }
            }
            return txt;
        }
        function updateAllDisplays() {
            renderBuyList();
            renderSellList();
            calculateNet();
        }

        function renderBuyList() {
            const list = document.getElementById("buyList"); list.innerHTML = "";
            let total = 0; const curr = document.getElementById("currencySelect").value;
            buyCart.forEach(e => {
                const li = document.createElement("li");
                let rowTotal = 0, rowText = "";
                if (e.isBalance) { rowTotal = e.price || 0; rowText = `Account Balance: ${rowTotal.toFixed(2)} BT`; }
                else if (e.bundleSize && e.isFullyCustom) { rowTotal = (e.qty / e.bundleSize) * e.price; rowText = `${e.qty} √ó ${e.name} (${e.price.toFixed(2)} BT per ${e.bundleSize}) (${rowTotal.toFixed(2)} BT)`; }
                else if (e.bundleSize) { rowTotal = e.qty * e.price; rowText = `${e.qty} √ó ${e.bundleSize} ${e.name} (${e.price.toFixed(2)} BT stack) (${rowTotal.toFixed(2)} BT)`; }
                else { rowTotal = e.qty * e.price; rowText = `${e.qty} √ó ${e.name} (${e.price.toFixed(2)} BT each) (${rowTotal.toFixed(2)} BT)`; }
                total += rowTotal;
                if (e.isConverter) rowText += ' [Converted]';
                if (e.source === 'OCM') rowText += ' [OCM]';
                const colorClass = evaluateRowColorBuy(e);
                if (colorClass) li.classList.add(colorClass);
                if (curr && curr !== BASE_CURRENCY) rowText += ' ' + formatValue(rowTotal, curr, true);
                li.textContent = rowText;
                const removeBtn = document.createElement("button");
                removeBtn.textContent = "‚ùå"; removeBtn.onclick = () => { buyCart = buyCart.filter(x => x !== e); renderBuyList(); calculateNet(); };
                li.appendChild(removeBtn);
                list.appendChild(li);
            });
            document.getElementById("buyTotal").textContent = formatValue(total, curr, true);
            calculateNet();
        }

        function renderSellList() {
            const list = document.getElementById("sellList"); list.innerHTML = "";
            let total = 0; const curr = document.getElementById("currencySelect").value;
            sellCart.forEach(e => {
                const li = document.createElement("li");
                let rowTotal = 0, rowText = "";
                if (e.isBalance) { rowTotal = e.price || 0; rowText = `Account Balance: ${rowTotal.toFixed(2)} BT`; }
                else if (e.bundleSize && e.isFullyCustom) { rowTotal = (e.qty / e.bundleSize) * e.price; rowText = `${e.qty} √ó ${e.name} (${e.price} BT per ${e.bundleSize}) (${rowTotal.toFixed(2)} BT)`; }
                else if (e.bundleSize) { rowTotal = e.qty * e.price; rowText = `${e.qty} √ó ${e.bundleSize} ${e.name} (${e.price.toFixed(2)} BT stack) (${rowTotal.toFixed(2)} BT)`; }
                else { rowTotal = e.qty * e.price; rowText = `${e.qty} √ó ${e.name} (${e.price.toFixed(2)} BT each) (${rowTotal.toFixed(2)} BT)`; }
                if (e.isPayWith) rowText += ' [Pay With]';
                if (e.source === 'OCM') rowText += ' [OCM]';
                total += rowTotal;
                const colorClass = evaluateRowColorSell(e);
                if (colorClass) {
                    li.classList.add(colorClass);
                    if (colorClass === 'row-warning-red') {
                        const warn = document.createElement('span'); warn.className = 'small-note';
                        warn.textContent = 'over target stock ‚Äî forced recalculation';
                        li.appendChild(warn);
                    }
                }
                if (curr && curr !== BASE_CURRENCY) rowText += ' ' + formatValue(rowTotal, curr, false);
                li.textContent = rowText;
                const removeBtn = document.createElement("button");
                removeBtn.textContent = "‚ùå"; removeBtn.onclick = () => { sellCart = sellCart.filter(x => x !== e); renderSellList(); calculateNet(); };
                li.appendChild(removeBtn);
                list.appendChild(li);
            });
            document.getElementById("sellTotal").textContent = formatValue(total, curr, false);
            calculateNet();
        }

        function calculateNet() {
            const buyTotal = buyCart.reduce((s, e) => {
                if (e.isBalance) return s + (e.price || 0);
                if (e.bundleSize && e.isFullyCustom) return s + ((e.qty / e.bundleSize) * e.price);
                if (e.bundleSize) return s + (e.qty * e.price);
                return s + (e.qty * e.price);
            }, 0);
            const sellTotal = sellCart.reduce((s, e) => {
                if (e.isBalance) return s + (e.price || 0);
                if (e.bundleSize && e.isFullyCustom) return s + ((e.qty / e.bundleSize) * e.price);
                if (e.bundleSize) return s + (e.qty * e.price);
                return s + (e.qty * e.price);
            }, 0);
            const net = sellTotal - buyTotal;
            const curr = document.getElementById("currencySelect").value;
            const netSpan = document.getElementById("netTotal");
            netSpan.dataset.raw = String(net);
            netSpan.textContent = formatValue(net, curr, net < 0);
            netSpan.className = net >= 0 ? 'positive' : 'negative';
        }

        function buildRequestPayload() {
            const buyItems = buyCart.map(b => ({ name: b.name, qty: b.qty, priceBT: b.price, bundleSize: b.bundleSize || null, source: b.source || 'STORE' }));
            const sellItems = sellCart.map(s => ({ name: s.name, qty: s.qty, priceBT: s.price, bundleSize: s.bundleSize || null, source: s.source || 'STORE' }));
            const totals = {
                buyBT: buyItems.reduce((s, i) => s + (i.priceBT * (i.bundleSize ? i.qty : i.qty)), 0),
                sellBT: sellItems.reduce((s, i) => s + (i.priceBT * (i.bundleSize ? i.qty : i.qty)), 0)
            };
            totals.netBT = totals.sellBT - totals.buyBT;
            return {
                requestId: cryptoRandomId(),
                createdAt: new Date().toISOString(),
                user: {
                    userId: currentUser?.userId,
                    email: currentUser?.email,
                    playerName: currentUser?.playerName,
                    mailbox: currentUser?.mailbox
                },
                carts: { buy: buyItems, sell: sellItems },
                totals,
                priceSource: { sheetId: 'PRICE_SHEET', asOf: new Date().toISOString() }
            };
        }

        function submitPurchaseRequest() {
            if (!googleIdToken) return alert('Login first');
            const payload = buildRequestPayload();

            // If local flag is set, we skip getting a token. Server will accept when the user already passed once.
            const skipCaptcha = localStorage.getItem('vak_captcha_ok') === '1';
            const doPost = (tokenOrNull) => {
                const body = {
                    action: 'createRequest',
                    idToken: googleIdToken,
                    payload
                };
                if (tokenOrNull) body.recaptchaToken = tokenOrNull; // include only when available
                return fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
            };

            (skipCaptcha ? Promise.resolve(null) : recaptchaWrap())
                .then(token => doPost(token))
                .then(r => r.json())
                .then(j => {
                    if (!j.ok) throw new Error(j.error);
                    document.getElementById('requestMsg').textContent = 'Request submitted. ID: ' + j.result.requestId;
                })
                .catch(e => {
                    document.getElementById('requestMsg').textContent = 'Error: ' + e.message;
                });
        }

        function copyTransactionData() {
            const payload = buildRequestPayload();
            navigator.clipboard.writeText(JSON.stringify(payload, null, 2))
                .then(() => document.getElementById('requestMsg').textContent = 'Transaction data copied.')
                .catch(e => document.getElementById('requestMsg').textContent = 'Copy failed: ' + e.message);
        }

        /* Pay With */
        function addPayRow() {
            const div = document.createElement("div"); div.className = "payRow";
            const unique = 'paySelect_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
            const input = document.createElement("input"); input.id = unique; input.className = 'dropdown-input'; input.placeholder = 'Item name';
            const list = document.createElement("div"); list.id = unique + 'List'; list.className = 'dropdown-list'; list.style.display = 'none';
            const wrap = document.createElement('div'); wrap.className = 'dropdown-wrap'; wrap.appendChild(input); wrap.appendChild(list);
            const percent = document.createElement("input"); percent.type = "number"; percent.value = 0; percent.min = 0; percent.max = 100; percent.placeholder = "%";
            const removeRowBtn = document.createElement("button"); removeRowBtn.type = "button"; removeRowBtn.textContent = "‚ùå"; removeRowBtn.onclick = () => { div.remove(); calculatePayment(); };
            div.appendChild(wrap); div.appendChild(document.createTextNode(" % of total: ")); div.appendChild(percent); div.appendChild(removeRowBtn);
            document.getElementById("payOptions").appendChild(div);
            attachDropdown(input.id, list.id, (q) => {
                const ql = (q || "").toLowerCase();
                if (!ql) return dropdownData.slice(0, 200);
                return dropdownData.filter(d => d.name.toLowerCase().includes(ql));
            }, () => { });
        }

        function calculatePayment() {
            const payListEl = document.getElementById("payList"); payListEl.innerHTML = "";
            const netSpan = document.getElementById("netTotal");
            const netRaw = parseFloat(netSpan.dataset.raw);
            const totalNet = !isNaN(netRaw) ? netRaw : parseFloat((netSpan.textContent || "0").replace(/[^\d.-]/g, "")) || 0;
            if (totalNet >= 0) {
                document.getElementById("paymentResult").textContent = `‚úÖ Net Balance is ${totalNet.toFixed(2)} BT. No payment needed.`;
                sellCart = sellCart.filter(e => !e.isPayWith);
                renderSellList(); calculateNet(); return;
            }
            const owed = -totalNet; let usedPercent = 0;
            sellCart = sellCart.filter(e => !e.isPayWith);
            const curr = document.getElementById("currencySelect").value;
            const rows = document.querySelectorAll("#payOptions .payRow");
            rows.forEach(row => {
                const inputEl = row.querySelector('input.dropdown-input');
                const percentEl = row.querySelector('input[type="number"]');
                const rawName = (inputEl?.value || "").trim();
                const percent = parseFloat(percentEl?.value) || 0;
                if (!rawName || percent <= 0) return;
                let item = payItems.find(i => i.name.toLowerCase() === rawName.toLowerCase()) ||
                    payItems.find(i => i.name.toLowerCase().includes(rawName.toLowerCase()));
                if (!item) return;
                usedPercent += percent;
                const portion = (percent / 100) * owed;
                let stackPrice = item.buyStack || (item.buyEach && item.bundleSize ? item.buyEach * item.bundleSize : 0);
                let indivPrice = item.buyEach || (item.buyStack && item.bundleSize ? item.buyStack / item.bundleSize : 0);
                if ((!stackPrice || stackPrice <= 0) && (!indivPrice || indivPrice <= 0)) return;
                let stacks = 0, individuals = 0, leftover = portion;
                if (stackPrice > 0) { stacks = Math.floor(portion / stackPrice); leftover -= stacks * stackPrice; }
                if (indivPrice > 0 && leftover > 0) { const addIndividuals = Math.floor(leftover / indivPrice); individuals += addIndividuals; leftover -= addIndividuals * indivPrice; }
                const payId = 'pay_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
                const li = document.createElement("li"); li.dataset.payid = payId;
                let payText = `${percent}% = `;
                if (stacks > 0) payText += `${stacks} stack(s) √ó ${item.bundleSize} ${item.name} (${stackPrice.toFixed(2)} BT stack)`;
                if (individuals > 0) { if (stacks > 0) payText += ' + '; payText += `${individuals} √ó ${item.name} (${indivPrice.toFixed(2)} BT each)`; }
                const totalBT = stacks * stackPrice + individuals * indivPrice;
                payText += ` (${totalBT.toFixed(2)} BT)`;
                if (curr && curr !== BASE_CURRENCY) payText += ' ' + formatValue(totalBT, curr, false);
                li.textContent = payText;
                const removeBtn = document.createElement("button"); removeBtn.textContent = "‚ùå";
                removeBtn.onclick = () => { sellCart = sellCart.filter(it => !(it.isPayWith && it._payId === payId)); li.remove(); renderSellList(); calculateNet(); };
                li.appendChild(removeBtn);
                payListEl.appendChild(li);
                if (stacks > 0) sellCart.push({ name: item.name, qty: stacks, price: stackPrice, bundleSize: item.bundleSize, isPayWith: true, _payId: payId });
                if (individuals > 0) sellCart.push({ name: item.name, qty: individuals, price: indivPrice, isPayWith: true, _payId: payId });
            });
            document.getElementById("paymentResult").textContent = usedPercent !== 100
                ? `‚ö†Ô∏è Warning: payment percentages total ${usedPercent}%, not 100%.`
                : `To pay ${owed.toFixed(2)} BT, bring the items listed above.`;
            renderSellList(); calculateNet();
        }

        function addConverterRow() {
            const div = document.createElement("div"); div.className = "payRow";
            const unique = 'convSelect_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
            const input = document.createElement("input"); input.id = unique; input.className = 'dropdown-input'; input.placeholder = 'Item name';
            const list = document.createElement("div"); list.id = unique + 'List'; list.className = 'dropdown-list'; list.style.display = 'none';
            const wrap = document.createElement('div'); wrap.className = 'dropdown-wrap'; wrap.appendChild(input); wrap.appendChild(list);
            const percent = document.createElement("input"); percent.type = "number"; percent.value = 0; percent.min = 0; percent.max = 100; percent.placeholder = "%";
            const removeRowBtn = document.createElement("button"); removeRowBtn.type = "button"; removeRowBtn.textContent = "‚ùå";
            removeRowBtn.onclick = () => { div.remove(); calculateConversion(); };
            div.appendChild(wrap); div.appendChild(document.createTextNode(" % of Net Balance: ")); div.appendChild(percent); div.appendChild(removeRowBtn);
            document.getElementById("converterOptions").appendChild(div);
            attachDropdown(input.id, list.id, (q) => {
                const ql = (q || "").toLowerCase();
                if (!ql) return dropdownData.slice(0, 200);
                return dropdownData.filter(d => d.name.toLowerCase().includes(ql));
            }, () => { });
        }

        function calculateConversion() {
            const converterList = document.getElementById("converterListDisplay");
            converterList.innerHTML = '';
            const netBT = parseFloat(document.getElementById("netTotal").dataset.raw) || 0;
            if (netBT <= 0) { document.getElementById("converterResult").textContent = '‚ö†Ô∏è Net Balance is not positive.'; return; }
            buyCart = buyCart.filter(e => !e.isConverter);
            const rows = document.querySelectorAll("#converterOptions .payRow");
            let usedPercent = 0;
            rows.forEach(row => {
                const inputEl = row.querySelector('input.dropdown-input');
                const name = inputEl?.value.trim() || '';
                const percent = parseFloat(row.querySelector('input[type="number"]').value) || 0;
                const item = items.find(i => i.name === name);
                if (!item || percent <= 0) return;
                usedPercent += percent;
                const portion = (percent / 100) * netBT;
                let stackPrice = item.sellStack || (item.sellEach && item.bundleSize ? item.sellEach * item.bundleSize : 0);
                let indivPrice = item.sellEach || (item.sellStack && item.bundleSize ? item.sellStack / item.bundleSize : 0);
                if (!stackPrice && !indivPrice) return;
                let stacks = 0, individuals = 0, leftover = portion;
                if (stackPrice > 0) { stacks = Math.floor(portion / stackPrice); leftover -= stacks * stackPrice; }
                if (indivPrice > 0) { const addIndividuals = Math.floor(leftover / indivPrice); individuals += addIndividuals; leftover -= addIndividuals * indivPrice; }
                const rowId = 'conv_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
                if (stacks > 0) buyCart.push({ name: item.name, qty: stacks, price: stackPrice, bundleSize: item.bundleSize, isConverter: true, _rowId: rowId });
                if (individuals > 0) buyCart.push({ name: item.name, qty: individuals, price: indivPrice, isConverter: true, _rowId: rowId });
                const li = document.createElement('li');
                let txt = `${percent}% = `;
                if (stacks > 0) txt += `${stacks} stack(s) √ó ${item.bundleSize} ${item.name} (${stackPrice.toFixed(2)} BT stack)`;
                if (individuals > 0) { if (stacks > 0) txt += ' + '; txt += `${individuals} √ó ${item.name} (${indivPrice.toFixed(2)} BT each)`; }
                const totalBT = stacks * stackPrice + individuals * indivPrice;
                txt += ` (${totalBT.toFixed(2)} BT)`;
                const curr = document.getElementById("currencySelect").value;
                if (curr && curr !== BASE_CURRENCY) txt += ' ' + formatValue(totalBT, curr, true);
                li.textContent = txt;
                const removeBtn = document.createElement('button'); removeBtn.textContent = '‚ùå';
                removeBtn.onclick = () => { buyCart = buyCart.filter(e => !(e.isConverter && e._rowId === rowId)); li.remove(); renderBuyList(); calculateNet(); };
                li.appendChild(removeBtn);
                converterList.appendChild(li);
            });
            renderBuyList();
            document.getElementById("converterResult").textContent = usedPercent === 0
                ? '‚ö†Ô∏è No allocations set.'
                : `‚úÖ Conversion done. Allocated ${usedPercent}% of Net Balance.`;
        }

        function quickStackCalc() {
            const name = document.getElementById("quickStackSelect").value;
            const qty = parseInt(document.getElementById("quickStackQty").value) || 0;
            const item = items.find(i => i.name === name); if (!item) return;
            const buyText = item.buyStack ? `${qty} √ó ${item.bundleSize} ${item.name} buys for ${(qty * item.buyStack).toFixed(2)} BT` : "";
            const sellText = item.sellStack ? `${qty} √ó ${item.bundleSize} ${item.name} sells for ${(qty * item.sellStack).toFixed(2)} BT` : "";
            document.getElementById("quickStackResult").textContent = [buyText, sellText].filter(Boolean).join(" | ");
        }
        function quickIndivCalc() {
            const name = document.getElementById("quickIndivSelect").value;
            const qty = parseInt(document.getElementById("quickIndivQty").value) || 0;
            const item = items.find(i => i.name === name); if (!item) return;
            const buyText = item.buyEach ? `${qty} √ó ${item.name} buys for ${(qty * item.buyEach).toFixed(2)} BT` : "";
            const sellText = item.sellEach ? `${qty} √ó ${item.name} sells for ${(qty * item.sellEach).toFixed(2)} BT` : "";
            document.getElementById("quickIndivResult").textContent = [buyText, sellText].filter(Boolean).join(" | ");
        }

        function addStack() {
            const name = document.getElementById("stackSelect").value;
            const qty = parseInt(document.getElementById("stackQty").value) || 0;
            const item = items.find(i => i.name === name); if (!item || !item.sellStack) return;
            buyCart.push({ name: item.name, qty, price: item.sellStack, bundleSize: item.bundleSize, source: 'STORE' });
            renderBuyList();
        }
        function addIndividual() {
            const name = document.getElementById("indivSelect").value;
            const qty = parseInt(document.getElementById("indivQty").value) || 0;
            const item = items.find(i => i.name === name); if (!item || !item.sellEach) return;
            buyCart.push({ name: item.name, qty, price: item.sellEach, source: 'STORE' }); renderBuyList();
        }
        function addBuyAccountBalance() {
            const balance = parseFloat(document.getElementById("buyAccountBalanceInput").value) || 0;
            if (balance <= 0) return;
            buyCart.push({ name: "Account Balance", qty: 1, price: balance, isBalance: true, source: 'BALANCE' }); renderBuyList();
        }
        function addCustomBuyStack() {
            const name = document.getElementById("customBuyStackSelect").value;
            const qty = parseInt(document.getElementById("customBuyStackQty").value) || 0;
            const price = parseFloat(document.getElementById("customBuyStackPrice").value) || 0;
            const item = items.find(i => i.name === name);
            if (!item || qty <= 0 || price <= 0) return;
            buyCart.push({ name: item.name, qty, price, bundleSize: item.bundleSize, isCustom: true, source: 'STORE' }); renderBuyList();
        }
        function addCustomBuyIndividual() {
            const name = document.getElementById("customBuyIndivSelect").value;
            const qty = parseInt(document.getElementById("customBuyIndivQty").value) || 0;
            const price = parseFloat(document.getElementById("customBuyIndivPrice").value) || 0;
            const item = items.find(i => i.name === name);
            if (!item || qty <= 0 || price <= 0) return;
            buyCart.push({ name: item.name, qty, price, isCustom: true, source: 'STORE' }); renderBuyList();
        }
        function addFullyCustomBuy() {
            const name = document.getElementById("customBuyName").value.trim();
            const qty = parseInt(document.getElementById("customBuyQty").value) || 0;
            const stackSize = parseInt(document.getElementById("customBuyStackSize").value) || 1;
            const price = parseFloat(document.getElementById("customBuyPrice").value) || 0;
            if (!name || qty <= 0 || price <= 0 || stackSize <= 0) return;
            buyCart.push({ name, qty, bundleSize: stackSize, price, isFullyCustom: true, source: 'CUSTOM' }); renderBuyList();
        }

        function addSellStack() {
            const name = document.getElementById("sellStackSelect").value;
            const qty = parseInt(document.getElementById("sellStackQty").value) || 0;
            const item = items.find(i => i.name === name); if (!item || !item.buyStack) return;
            sellCart.push({ name: item.name, qty, price: item.buyStack, bundleSize: item.bundleSize, source: 'STORE' }); renderSellList();
        }
        function addSellIndividual() {
            const name = document.getElementById("sellIndivSelect").value;
            const qty = parseInt(document.getElementById("sellIndivQty").value) || 0;
            const item = items.find(i => i.name === name); if (!item || !item.buyEach) return;
            sellCart.push({ name: item.name, qty, price: item.buyEach, source: 'STORE' }); renderSellList();
        }
        function addAccountBalance() {
            const balance = parseFloat(document.getElementById("accountBalanceInput").value) || 0;
            if (balance <= 0) return;
            sellCart.push({ name: "Account Balance", qty: 1, price: balance, isBalance: true, source: 'BALANCE' }); renderSellList();
        }
        function addCustomSellStack() {
            const name = document.getElementById("customSellStackSelect").value;
            const qty = parseInt(document.getElementById("customSellStackQty").value) || 0;
            const price = parseFloat(document.getElementById("customSellStackPrice").value) || 0;
            const item = items.find(i => i.name === name);
            if (!item || qty <= 0 || price <= 0) return;
            sellCart.push({ name: item.name, qty, price, bundleSize: item.bundleSize, isCustom: true, source: 'STORE' }); renderSellList();
        }
        function addCustomSellIndividual() {
            const name = document.getElementById("customSellIndivSelect").value;
            const qty = parseInt(document.getElementById("customSellIndivQty").value) || 0;
            const price = parseFloat(document.getElementById("customSellIndivPrice").value) || 0;
            const item = items.find(i => i.name === name);
            if (!item || qty <= 0 || price <= 0) return;
            sellCart.push({ name: item.name, qty, price, isCustom: true, source: 'STORE' }); renderSellList();
        }
        function addFullyCustomSell() {
            const name = document.getElementById("customSellName").value.trim();
            const qty = parseInt(document.getElementById("customSellQty").value) || 0;
            const stackSize = parseInt(document.getElementById("customSellStackSize").value) || 1;
            const price = parseFloat(document.getElementById("customSellPrice").value) || 0;
            if (!name || qty <= 0 || price <= 0 || stackSize <= 0) return;
            sellCart.push({ name, qty, bundleSize: stackSize, price, isFullyCustom: true, source: 'CUSTOM' }); renderSellList();
        }

        function toggleInfo(id) { const el = document.getElementById(id); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }
        function openHistory() { alert('History page coming soon.'); }
        function openOCM() { alert('OCM main page coming soon.'); }

        window.onload = () => {
            checkHashForIdToken();
            loadData();
            addPayRow();
            initRecaptcha();
            const gsiWait = setInterval(() => {
                if (window.google && google.accounts && google.accounts.id) {
                    initGoogleIdentity(); clearInterval(gsiWait);
                }
            }, 200);
            setTimeout(() => clearInterval(gsiWait), 4000);
        };
    </script>

    <!-- Load GSI last -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</body>
</html>